# OpsNow Copilot RAG 설계 (v0.4)

> Recursive Summarization + Agentic RAG 통합 아키텍처

---

## 1. 개요

### 1.1 시스템 구성

| 구성요소 | 역할 | 저장소 |
|----------|------|--------|
| **Long-term Memory** | 대화 맥락 유지 (Recursive Summarization) | Redis |
| **Agentic RAG** | FAQ/Guide 검색 (pydantic-ai Agent) | FAISS |
| **Fallback** | 메뉴 링크 제안 | In-Memory |

### 1.2 핵심 특징

| 항목 | 설명 |
|------|------|
| 메모리 방식 | Recursive Summarization (검색 없음) |
| RAG 방식 | pydantic-ai Agent + Self-Reflective Loop |
| 검색 비율 | FAQ 3 : Guide 7 |
| 최대 Tool Call | 3회 (이후 Fallback) |

---

## 2. 전체 아키텍처

```
┌─────────────────────────────────────────────────────────────────┐
│                        사용자 질문                                │
│                   "EC2 비용 줄이는 방법?"                          │
└─────────────────────────────────────────────────────────────────┘
                              │
              ┌───────────────┴───────────────┐
              ▼                               ▼
┌──────────────────────────┐    ┌──────────────────────────┐
│   Long-term Memory       │    │     Agentic RAG          │
│   (Redis Only)           │    │     (FAISS)              │
├──────────────────────────┤    ├──────────────────────────┤
│ - 단기기억 (5턴 원본)     │    │ - search_all             │
│ - Long-term (~500토큰)   │    │   (FAQ 3 + Guide 7)      │
│ - Entities (~200토큰)    │    │ - Rerank + 충분성 평가    │
└──────────────────────────┘    │ - 재검색/섹션확장         │
              │                  └──────────────────────────┘
              │                               │
              └───────────────┬───────────────┘
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                      Context Builder                             │
│   System Prompt + Memory + Entities + 단기기억 + RAG + 현재 질문   │
│                        (~5,300 토큰)                              │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
                    ┌─────────────────┐
                    │ confidence<0.5? │
                    └────────┬────────┘
                      Yes    │    No
                       ▼     │     ▼
              ┌─────────────┐│┌─────────────┐
              │  Fallback   │││ 응답 생성    │
              │ (메뉴 링크)  │││             │
              └─────────────┘│└─────────────┘
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                        최종 응답                                  │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼ (비동기)
┌─────────────────────────────────────────────────────────────────┐
│              단기 > 5턴 → Memory Update 트리거                    │
│              Mi = LLM(Mi-1, Si)                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## 3. Long-term Memory (Recursive Summarization)

### 3.1 핵심 개념

| 개념 | 설명 |
|------|------|
| **Recursive Summarization** | Mi = LLM(Si, Mi-1) - 이전 메모리 + 새 대화 → 새 메모리 |
| **State, Not Log** | 메모리는 누적 로그가 아니라 계속 재작성되는 상태 |
| **No Retrieval** | 검색 없이 항상 전체 메모리 사용 → noise 제거 |
| **Bounded Size** | ≤20문장 (~500토큰) 고정 |

```
Past Sessions
     │
     ▼
    S1  ───▶  M1
               │
    S2  ───▶  M2
               │
    S3  ───▶  M3   ← (실시간으로 업데이트된 최신 메모리)
               │
               ▼
Current Session
         │
         ▼
     Response
```

→ 메모리는 누적되지 않고 **매번 덮어쓰기** (State, Not Log)

### 3.2 메모리 구조 (Redis)

```
┌─────────────────────────────────────────────────────────┐
│                      Redis Only                          │
├─────────────────────────────────────────────────────────┤
│  단기기억: 최근 5턴 (원본 그대로)                         │
│  용도: "아까 그거" 정확히 찾기                           │
├─────────────────────────────────────────────────────────┤
│  Long-term Memory: 단일 상태 (~500 토큰)                 │
│  용도: 전체 대화 맥락 유지 ("뭐하던 중이었지?")           │
├─────────────────────────────────────────────────────────┤
│  Entities: 구조화된 정보 (최대 25개, FIFO)               │
│  용도: 핵심 숫자/키워드 보존 (요약하면 날아가는 것들)      │
├─────────────────────────────────────────────────────────┤
│  TTL: 24시간 미사용 시 자동 삭제                          │
└─────────────────────────────────────────────────────────┘
```

### 3.3 Redis 키 구조

| 키 | TTL | 내용 |
|----|-----|------|
| `chat:{tenant}:{session}:short` | 24h | 단기기억 (최근 5턴 원본) |
| `chat:{tenant}:{session}:memory` | 24h | Long-term Memory (요약) |
| `chat:{tenant}:{session}:entities` | 24h | Entities (배열, 턴 번호 포함) |

### 3.4 Memory Update 흐름

```
[턴1] [턴2] [턴3] [턴4] [턴5] [턴6] ... [현재]
                              │
                              ▼
              단기 > 5턴 시 업데이트 트리거
                              │
                              ▼
        ┌───────────────────────────────────┐
        │ Recursive Summarization           │
        │ Mi = LLM(Mi-1, new_turns)         │
        │                                   │
        │ Input: 이전 메모리 + 새 5턴        │
        │ Output: 새 메모리 + Entities      │
        │                                   │
        │ → 새 메모리로 덮어쓰기             │
        └───────────────────────────────────┘
```

### 3.5 메모리 보정 규칙

#### Long-term Memory 규칙

| 규칙 | 설명 |
|------|------|
| 최근 대화 우선 | 새 대화 내용이 더 중요 |
| 주제 전환 감지 | 주제가 바뀌면 이전 주제는 한 줄로 압축 |
| 오래된 정보 정리 | 더 이상 관련 없는 내용은 과감히 삭제 |

#### Entities 규칙

| 규칙 | 설명 |
|------|------|
| 같은 키는 덮어쓰기 | 기존 제거 + 배열 끝에 push (순서 갱신) |
| 최대 25개 제한 (FIFO) | 초과 시 배열 앞에서 shift (가장 오래된 것 삭제) |
| 주제 바뀌어도 유지 | 자연스럽게 밀려날 때까지 보존 |

#### Entities 저장 구조

```json
[
  {"key": "provider", "value": "aws", "turn": 3},
  {"key": "budget", "value": "$10,000", "turn": 5},
  {"key": "top_service", "value": "ec2", "turn": 7}
]
```

| 동작 | 처리 |
|------|------|
| 새 Entity 추가 | 배열 끝에 push |
| 같은 key 업데이트 | 기존 제거 + 끝에 push (순서 갱신) |
| 25개 초과 | 배열 앞에서 shift (가장 오래된 것 삭제) |

### 3.6 암묵적 참조 시나리오

```
User: "11월 분석해줘"
Assistant: "11월 AWS 총 비용은 $12,500..."

(몇 턴 후)

User: "1월은?"
```

| 방식 | 결과 |
|------|------|
| **Fact 검색 (Mem0)** | ❌ "1월" 검색 → "11월" fact 못 찾음 |
| **Recursive Summarization** | ✅ 전체 맥락에서 LLM이 "11월처럼 1월도" 유추 |

→ 검색 없이 전체 맥락 사용하므로 암묵적 참조 해결 가능

---

## 4. Agentic RAG (FAQ/Guide 검색)

### 4.1 아키텍처

```
┌────────────────────────────────────────────────────────────────┐
│                pydantic-ai Agent Loop (최대 3회 호출)            │
├────────────────────────────────────────────────────────────────┤
│                                                                │
│   Query → search_all (FAQ 3 + Guide 7)                        │
│              │                                                 │
│              ▼                                                 │
│   Rerank + 충분성 평가 (gpt-5-nano, 1회 LLM)                   │
│              │                                                 │
│   ┌──────────┼──────────┐                                     │
│   ▼          ▼          ▼                                     │
│ 충분      search_again  get_section                           │
│   │      (refined_query) (섹션 확장)                           │
│   │          │              │                                 │
│   │          └──────────────┘                                 │
│   │                │                                          │
│   │                ▼                                          │
│   │         다시 Rerank                                       │
│   │                │                                          │
│   │      ┌─────────┴─────────┐                               │
│   ▼      ▼                   ▼                               │
│ 응답 생성              3회 초과 → Fallback                     │
│                                                               │
└───────────────────────────────────────────────────────────────┘
```

### 4.2 Agent 도구 (3개)

| 도구 | 역할 |
|------|------|
| `search_all` | FAQ 3개 + Guide 7개 통합 검색 → Rerank + 충분성 |
| `search_by_metadata` | doc_type, has_steps 등 필터 검색 |
| `get_section` | 문서 섹션 전체 가져오기 (확장) |

### 4.3 Rerank + 충분성 평가 (통합)

1회 LLM 호출로 Rerank와 충분성 평가 동시 처리:

```json
{
    "ranked_indices": [3, 1, 5],
    "is_sufficient": true,
    "missing": ["steps", "conditions"],
    "next_action": "get_section" | "search_again" | null,
    "refined_query": "개선된 쿼리 (search_again 시)",
    "confidence": 0.85
}
```

### 4.4 Fallback 규칙

| 조건 | 처리 |
|------|------|
| 3회 호출 후 is_sufficient=false | 있는 컨텍스트로 최선의 답변 |
| confidence < 0.5 | "관련 문서를 찾지 못했습니다" + 메뉴 링크 제안 |
| ranked_results 비어있음 | "해당 내용은 준비 중입니다" |

---

## 5. Context Builder

### 5.1 LLM 컨텍스트 구조

```
┌─────────────────────────────────────────┐
│ System Prompt (~1500 토큰)              │
├─────────────────────────────────────────┤
│ Long-term Memory (~500 토큰)            │
│ "사용자는 AWS 비용 분석 중. EC2가 65%..." │
├─────────────────────────────────────────┤
│ Entities (~200 토큰)                    │
│ provider: aws, budget: $10,000, ...     │
├─────────────────────────────────────────┤
│ 단기기억 (~1500 토큰)                    │
│ 최근 5턴 원본                            │
├─────────────────────────────────────────┤
│ FAQ/Guide RAG 결과 (~1500 토큰)         │
├─────────────────────────────────────────┤
│ 현재 질문 (~100 토큰)                    │
└─────────────────────────────────────────┘
         총 ~5,300 토큰
```

### 5.2 토큰 예산

| 구성요소 | 예산 | 비고 |
|----------|------|------|
| System Prompt | ~1500 | 역할 + 규칙 + 도구 설명 |
| Long-term Memory | ~500 | 전체 맥락 (고정) |
| Entities | ~200 | 구조화 정보 (최대 25개) |
| 단기기억 | ~1500 | 5턴 × 300토큰/턴 |
| FAQ/Guide | ~1500 | RAG 결과 |
| 현재 질문 | ~100 | 가변 |
| **총합** | **~5300** | |

---

## 6. 파일 구조

```
src/
├── memory/
│   ├── longterm_memory.py      # Long-term Memory 클래스
│   └── memory_summarizer.py    # Recursive Summarization 모듈
├── agent/
│   ├── rag_agent.py            # pydantic-ai Agent 정의 + 실행
│   ├── tools.py                # search_all, search_by_metadata, get_section
│   └── models.py               # Pydantic 모델
├── retrieval/
│   ├── search.py               # FAISS 검색 로직
│   └── reranker.py             # Rerank + 충분성 통합 평가
├── batch/
│   └── embedding_processor.py  # 임베딩 배치 + 메타데이터 태깅
└── processors/
    └── guide_processor.py      # 메인 진입점
```

---

## 7. 비용 분석

### 7.1 모델별 가격

> gpt-5-nano: Input $0.05/1M, Output $0.40/1M
> 기준: 300 토큰/턴

### 7.2 컴포넌트별 비용

| 컴포넌트 | 계산 | 비용/회 |
|----------|------|---------|
| Memory Update (5턴마다) | ~2000 in + ~400 out | ~$0.0003 |
| Rerank + 충분성 (1~2회) | ~1000 in + ~500 out | ~$0.0003 |
| Agent 응답 생성 | ~1500 in + ~1000 out | ~$0.00055 |

### 7.3 월간 비용 추정 (1,000 세션/일, 300토큰/턴)

| 시나리오 | 턴/세션 | Memory Update | Agentic RAG | **총합** |
|----------|--------|---------------|-------------|----------|
| 일반 | 20턴 | $36/월 | $690/월 | **$726/월** |
| 무거운 사용 | 50턴 | $90/월 | $1,725/월 | **$1,815/월** |
| **최대** | **100턴** | **$180/월** | **$3,450/월** | **$3,630/월** |

---

## 8. 설정값 요약

| 항목 | 값 | 비고 |
|------|-----|------|
| 단기기억 크기 | 5턴 | 원본 유지 |
| 업데이트 단위 | 5턴 | 단기 초과 시 |
| Long-term Memory 최대 | 20문장 | ~500토큰 |
| Entities 최대 | 25개 | 배열 + 턴 번호, FIFO |
| TTL | 24시간 | 미사용 시 삭제 |
| 요약 모델 | gpt-5-nano | 비용 효율 |
| RAG 검색 비율 | FAQ 3 : Guide 7 | |
| 최대 Tool Call | 3회 | 이후 Fallback |

---

## 9. 구현 체크리스트

### Phase 1: 기반 구조
| # | 항목 | 상태 |
|---|------|------|
| 1 | Pydantic 모델 정의 (`models.py`) | [ ] |
| 2 | Redis 키 설계 | [ ] |

### Phase 2: Memory
| # | 항목 | 상태 |
|---|------|------|
| 3 | LongtermMemory 클래스 | [ ] |
| 4 | MemorySummarizer (Recursive Summarization) | [ ] |
| 5 | Entities 추출/FIFO 로직 | [ ] |

### Phase 3: RAG
| # | 항목 | 상태 |
|---|------|------|
| 6 | 임베딩 배치 처리 | [ ] |
| 7 | FAISS 검색 로직 | [ ] |
| 8 | Rerank + 충분성 통합 | [ ] |
| 9 | Agent 도구 정의 | [ ] |
| 10 | Agent 정의 + 실행 | [ ] |

### Phase 4: 통합
| # | 항목 | 상태 |
|---|------|------|
| 11 | Context Builder 연동 | [ ] |
| 12 | Fallback 처리 | [ ] |
| 13 | 배치 Cleanup | [ ] |
| 14 | 통합 테스트 | [ ] |

---

## 10. 참고 자료

### 핵심 논문

| 논문 | 핵심 내용 |
|------|----------|
| [Recursively Summarizing Enables Long-Term Dialogue Memory](https://arxiv.org/abs/2308.15022) | Mi = LLM(Si, Mi-1). 단일 요약 대비 BLEU +3%, MemoryBank 대비 48.2% 승률. [GitHub](https://github.com/qingyue2014/Rsum) |
| [Evaluating Very Long-Term Conversational Memory](https://arxiv.org/abs/2402.17753) | LoCoMo 벤치마크. 300턴/35세션 장기 대화 평가 |

### 참고 리소스

| 리소스 | 설명 |
|--------|------|
| [pydantic-ai](https://ai.pydantic.dev/) | Agent 프레임워크 |
| [Agent Memory Paper List](https://github.com/Shichun-Liu/Agent-Memory-Paper-List) | Agent Memory 논문 큐레이션 |
