<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IndexedDB Cache Design - OpsNow Copilot</title>
    <script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>
    <style>
        :root {
            --primary: #4F46E5;
            --secondary: #10B981;
            --warning: #F59E0B;
            --danger: #EF4444;
            --dark: #1F2937;
            --light: #F9FAFB;
            --white: #FFFFFF;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Pretendard', -apple-system, BlinkMacSystemFont, system-ui, sans-serif;
            line-height: 1.7;
            color: var(--dark);
            background: linear-gradient(135deg, #0f172a 0%, #1e3a5f 50%, #2d5a87 100%);
            min-height: 100vh;
            padding: 40px 20px;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            color: var(--white);
            margin-bottom: 40px;
        }

        header h1 {
            font-size: 2.5rem;
            margin-bottom: 15px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
        }

        header .subtitle {
            font-size: 1.2rem;
            opacity: 0.95;
        }

        header .badge {
            display: inline-block;
            background: rgba(255,255,255,0.2);
            padding: 8px 20px;
            border-radius: 20px;
            margin-top: 15px;
            font-size: 0.9rem;
        }

        .card {
            background: var(--white);
            border-radius: 20px;
            padding: 35px;
            margin-bottom: 25px;
            box-shadow: 0 15px 50px rgba(0,0,0,0.15);
        }

        .card h2 {
            color: var(--primary);
            font-size: 1.4rem;
            margin-bottom: 20px;
            padding-bottom: 12px;
            border-bottom: 3px solid #E0E7FF;
        }

        .card h3 {
            color: var(--dark);
            font-size: 1.1rem;
            margin: 25px 0 15px 0;
        }

        .highlight-box {
            background: linear-gradient(135deg, #EEF2FF 0%, #E0E7FF 100%);
            border-left: 5px solid var(--primary);
            padding: 20px;
            border-radius: 0 15px 15px 0;
            margin: 20px 0;
        }

        .highlight-box.success {
            background: linear-gradient(135deg, #D1FAE5 0%, #A7F3D0 100%);
            border-left-color: var(--secondary);
        }

        .highlight-box.warning {
            background: linear-gradient(135deg, #FEF3C7 0%, #FDE68A 100%);
            border-left-color: var(--warning);
        }

        .highlight-box.danger {
            background: linear-gradient(135deg, #FEE2E2 0%, #FECACA 100%);
            border-left-color: var(--danger);
        }

        .highlight-box h4 {
            color: var(--primary);
            margin-bottom: 8px;
            font-size: 1rem;
        }

        .highlight-box.success h4 { color: #065F46; }
        .highlight-box.warning h4 { color: #92400E; }
        .highlight-box.danger h4 { color: #991B1B; }

        .grid-2 {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            margin: 20px 0;
        }

        .grid-3 {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            margin: 20px 0;
        }

        .grid-4 {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            margin: 20px 0;
        }

        @media (max-width: 768px) {
            .grid-2, .grid-3, .grid-4 {
                grid-template-columns: 1fr;
            }
        }

        .flow-section {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            margin: 20px 0;
        }

        @media (max-width: 900px) {
            .flow-section { grid-template-columns: 1fr; }
        }

        .flow-card {
            background: var(--light);
            border-radius: 12px;
            padding: 20px;
        }

        .flow-card h4 {
            color: var(--dark);
            margin-bottom: 15px;
            font-size: 1rem;
        }

        .flow-card .mermaid {
            background: var(--white);
            border-radius: 8px;
            padding: 15px;
            overflow-x: auto;
        }

        .info-card {
            background: var(--light);
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            border: 2px solid transparent;
            transition: all 0.3s ease;
        }

        .info-card:hover {
            border-color: var(--primary);
            transform: translateY(-3px);
        }

        .info-card .icon {
            font-size: 2rem;
            margin-bottom: 12px;
        }

        .info-card h4 {
            color: var(--dark);
            margin-bottom: 8px;
            font-size: 0.95rem;
        }

        .info-card p {
            font-size: 0.85rem;
            color: #6B7280;
        }

        .badge-inline {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            margin-top: 8px;
        }

        .badge-green { background: #D1FAE5; color: #065F46; }
        .badge-blue { background: #DBEAFE; color: #1E40AF; }
        .badge-yellow { background: #FEF3C7; color: #92400E; }
        .badge-red { background: #FEE2E2; color: #991B1B; }
        .badge-purple { background: #EDE9FE; color: #5B21B6; }

        .mermaid-container {
            background: var(--white);
            padding: 25px;
            border-radius: 15px;
            margin: 20px 0;
            border: 1px solid #E5E7EB;
            overflow-x: auto;
        }

        .mermaid {
            display: flex;
            justify-content: center;
        }

        .tech-table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
        }

        .tech-table th {
            background: var(--light);
            padding: 12px 15px;
            text-align: left;
            border-bottom: 2px solid #E5E7EB;
            font-size: 0.9rem;
        }

        .tech-table td {
            padding: 12px 15px;
            border-bottom: 1px solid #E5E7EB;
            font-size: 0.9rem;
        }

        .tech-table code {
            background: #E5E7EB;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.85rem;
            font-family: 'Fira Code', monospace;
        }

        .flow-step {
            display: flex;
            align-items: flex-start;
            gap: 20px;
            margin: 15px 0;
            padding: 20px;
            background: var(--light);
            border-radius: 15px;
        }

        .flow-step .number {
            width: 36px;
            height: 36px;
            background: var(--primary);
            color: var(--white);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 1rem;
            flex-shrink: 0;
        }

        .flow-step .content h4 {
            color: var(--dark);
            margin-bottom: 6px;
            font-size: 1rem;
        }

        .flow-step .content p {
            color: #6B7280;
            font-size: 0.9rem;
        }

        .code-block {
            background: #1F2937;
            color: #E5E7EB;
            padding: 20px;
            border-radius: 10px;
            font-family: 'Fira Code', monospace;
            font-size: 0.85rem;
            overflow-x: auto;
            margin: 15px 0;
        }

        .feature-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 15px;
            background: var(--light);
            border-radius: 10px;
            margin: 8px 0;
        }

        .feature-item .check {
            width: 24px;
            height: 24px;
            background: var(--secondary);
            color: var(--white);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 0.8rem;
            flex-shrink: 0;
        }

        .arrow-icon {
            width: 24px;
            height: 24px;
            background: var(--primary);
            color: var(--white);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.9rem;
            flex-shrink: 0;
        }

        .arrow-icon.outgoing { background: #3B82F6; }
        .arrow-icon.incoming { background: #10B981; }
        .arrow-icon.storage { background: #8B5CF6; }

        footer {
            text-align: center;
            color: var(--white);
            padding: 30px 0;
            opacity: 0.8;
            font-size: 0.9rem;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>IndexedDB Cache Design</h1>
            <p class="subtitle">OpsNow Copilot - í™”ë©´ ë°ì´í„° ìºì‹± ë° ì„œë²„ ì—°ë™ ì„¤ê³„</p>
            <span class="badge">PoC: IndexedDB Cache (Phase 1~4 ê²€ì¦ ì™„ë£Œ)</span>
        </header>

        <!-- ê°œìš” -->
        <div class="card">
            <h2>ì„¤ê³„ ê°œìš”</h2>

            <div class="grid-4">
                <div class="info-card">
                    <div class="icon">ğŸ”</div>
                    <h4>Network Hook</h4>
                    <p>Axios Interceptor<br>API ì‘ë‹µ ìë™ ìºì‹±</p>
                    <span class="badge-inline badge-blue">Interceptor</span>
                </div>
                <div class="info-card">
                    <div class="icon">ğŸ’¾</div>
                    <h4>IndexedDB ê´€ë¦¬</h4>
                    <p>TTL, ìš©ëŸ‰, ì¤‘ë³µ ë°©ì§€<br>ë©”ë‰´ë³„ ë¶„ë¦¬</p>
                    <span class="badge-inline badge-purple">Cache</span>
                </div>
                <div class="info-card">
                    <div class="icon">ğŸ”„</div>
                    <h4>WebSocket ì½œë°±</h4>
                    <p>ì„œë²„ â†’ í´ë¼ì´ì–¸íŠ¸<br>ë°ì´í„° ìš”ì²­/ì½”ë“œ ì‹¤í–‰</p>
                    <span class="badge-inline badge-green">Callback</span>
                </div>
                <div class="info-card">
                    <div class="icon">ğŸ›¡ï¸</div>
                    <h4>ì—ëŸ¬ ê²©ë¦¬</h4>
                    <p>ìºì‹œ ì¥ì•  ì‹œì—ë„<br>ì›ë³¸ ì•± ì˜í–¥ ì—†ìŒ</p>
                    <span class="badge-inline badge-yellow">100%</span>
                </div>
            </div>

            <div class="highlight-box">
                <h4>ê¸°ìˆ  ìŠ¤íƒ</h4>
                <p>
                    <strong>Network Intercept:</strong> Axios Response Interceptor (ê³µí†µ axios í†µì¼ ì „ì œ)<br>
                    <strong>Storage:</strong> IndexedDB (ë¸Œë¼ìš°ì € ë„¤ì´í‹°ë¸Œ)<br>
                    <strong>Communication:</strong> WebSocket (Server â†” Client ì½œë°±)<br>
                    <strong>Code Execution:</strong> new Function() sandbox (PoC) â†’ Web Worker (í”„ë¡œë•ì…˜)
                </p>
            </div>
        </div>

        <!-- PoC ê²€ì¦ ê²°ê³¼ -->
        <div class="card">
            <h2>PoC ê²€ì¦ ê²°ê³¼</h2>

            <table class="tech-table">
                <thead>
                    <tr><th>Phase</th><th>ê²€ì¦ í•­ëª©</th><th>ê²°ê³¼</th></tr>
                </thead>
                <tbody>
                    <tr>
                        <td><strong>Phase 1</strong></td>
                        <td>fetch/XHR ì˜¤ë²„ë¼ì´ë“œ + IndexedDB ì €ì¥/ì¡°íšŒ</td>
                        <td><span class="badge-inline badge-green">ê²€ì¦ ì™„ë£Œ</span></td>
                    </tr>
                    <tr>
                        <td><strong>Phase 2</strong></td>
                        <td>URL í•„í„°ë§, ë®ì–´ì“°ê¸°, TTL, ì¤‘ë³µ ë°©ì§€, ë©”ë‰´ë³„ ê´€ë¦¬</td>
                        <td><span class="badge-inline badge-green">ê²€ì¦ ì™„ë£Œ</span></td>
                    </tr>
                    <tr>
                        <td><strong>Phase 3</strong></td>
                        <td>ì—ëŸ¬ ê²©ë¦¬ 100%, ì„±ëŠ¥ ì˜í–¥ &lt; 1ms, Sentry ê³µì¡´</td>
                        <td><span class="badge-inline badge-green">ê²€ì¦ ì™„ë£Œ</span></td>
                    </tr>
                    <tr>
                        <td><strong>Phase 4</strong></td>
                        <td>WebSocket ì½œë°± â†’ IndexedDB ì¡°íšŒ End-to-End</td>
                        <td><span class="badge-inline badge-green">ê²€ì¦ ì™„ë£Œ</span></td>
                    </tr>
                </tbody>
            </table>
        </div>

        <!-- ì „ì²´ ì•„í‚¤í…ì²˜ -->
        <div class="card">
            <h2>ì „ì²´ ì•„í‚¤í…ì²˜</h2>

            <div class="mermaid-container">
                <div class="mermaid">
flowchart TB
    subgraph Browser["Browser (Client)"]
        App["OpsNow App<br>(React + Axios)"]
        Widget["Copilot Widget"]
        Hook["Network Hook<br>(Axios Interceptor)"]
        Handler["WS Handler<br>(ì½œë°± ì²˜ë¦¬)"]
        DB[("IndexedDB<br>copilot-cache")]

        App -->|"API ìš”ì²­<br>(Axios)"| Hook
        Hook -->|"fire-and-forget"| DB
        Widget -->|"WebSocket"| Handler
        Handler -->|"get / getAll"| DB
    end

    subgraph Server["Copilot Server (Python)"]
        WS["WebSocket<br>Endpoint"]
        LLM["LLM<br>(ReAct Loop)"]
        WS --> LLM
    end

    Handler <-->|"WebSocket<br>ì½œë°± íŒ¨í„´"| WS

    style Browser fill:#f0f9ff,stroke:#3b82f6
    style Server fill:#f0fdf4,stroke:#10b981
    style DB fill:#ede9fe,stroke:#8b5cf6
                </div>
            </div>

            <h3>ëª¨ë“ˆ êµ¬ì„±</h3>
            <div class="grid-3">
                <div class="info-card">
                    <h4>copilot-network-hook.js</h4>
                    <p>Axios Interceptor<br>API ì‘ë‹µ ê°ì§€ â†’ ì €ì¥</p>
                    <span class="badge-inline badge-blue">Network Hook</span>
                </div>
                <div class="info-card">
                    <h4>copilot-cache.js</h4>
                    <p>IndexedDB CRUD<br>TTL/ìš©ëŸ‰/ì¤‘ë³µ ê´€ë¦¬</p>
                    <span class="badge-inline badge-purple">Cache Manager</span>
                </div>
                <div class="info-card">
                    <h4>copilot-ws-handler.js</h4>
                    <p>WebSocket ì½œë°± ìˆ˜ì‹ <br>IndexedDB ì¡°íšŒ â†’ ì‘ë‹µ</p>
                    <span class="badge-inline badge-green">WS Handler</span>
                </div>
            </div>
        </div>

        <!-- Network Hook -->
        <div class="card">
            <h2>Network Hook â€” API ì‘ë‹µ ìºì‹±</h2>

            <div class="highlight-box warning">
                <h4>Axios Interceptor ì „í™˜ ì˜ˆì •</h4>
                <p>
                    í˜„ì¬ PoCëŠ” fetch/XHR Override ë°©ì‹ì´ë‚˜, ê³µí†µ axios í†µì¼ í›„ <strong>Axios Interceptorë¡œ ì „í™˜</strong> ì˜ˆì •.<br>
                    ì „í™˜ ì‹œ <strong>ì´ ëª¨ë“ˆë§Œ êµì²´</strong>ë˜ë©°, IndexedDB ì´í›„ íë¦„(Cache Manager, WS Handler, ì„œë²„)ì€ ë³€ê²½ ì—†ìŒ.
                </p>
                <table class="tech-table" style="margin: 10px 0 0 0; background: rgba(255,255,255,0.5);">
                    <thead><tr><th>í•­ëª©</th><th>Override (PoC)</th><th>Interceptor (ì „í™˜ í›„)</th></tr></thead>
                    <tbody>
                        <tr><td>ì¸í„°ì…‰íŠ¸</td><td>fetch/XHR ë˜í•‘</td><td><code>axios.interceptors.response.use()</code></td></tr>
                        <tr><td>ë¡œë“œ ìˆœì„œ</td><td>Appë³´ë‹¤ ë¨¼ì €</td><td>ì˜ì¡´ì„± ì—†ìŒ</td></tr>
                        <tr><td>response ì ‘ê·¼</td><td><code>response.clone()</code></td><td><code>response.data</code> ì§ì ‘</td></tr>
                        <tr><td>Sentry ì¶©ëŒ</td><td>ê°€ëŠ¥</td><td>ì—†ìŒ</td></tr>
                    </tbody>
                </table>
            </div>

            <div class="mermaid-container">
                <div class="mermaid">
flowchart LR
    A["Axios ì‘ë‹µ<br>(Response Interceptor)"] --> C{"í•„í„°ë§<br>shouldProcess()"}
    C -->|"ë¹„ëŒ€ìƒ"| D["ì›ë³¸ ì‘ë‹µ<br>ê·¸ëŒ€ë¡œ ë°˜í™˜"]
    C -->|"ëŒ€ìƒ"| E["ì›ë³¸ ì‘ë‹µ ë°˜í™˜<br>+ fire-and-forget ì €ì¥"]
    E --> F[("IndexedDB")]

    style F fill:#ede9fe,stroke:#8b5cf6
                </div>
            </div>

            <h3>í•„í„°ë§ ê·œì¹™</h3>
            <table class="tech-table">
                <thead>
                    <tr><th>ê¸°ì¤€</th><th>ì¡°ê±´</th><th>ì„¤ëª…</th></tr>
                </thead>
                <tbody>
                    <tr><td>URL íŒ¨í„´</td><td><code>/api/</code> í¬í•¨</td><td>API ê²½ë¡œë§Œ ëŒ€ìƒ</td></tr>
                    <tr><td>URL ì œì™¸</td><td><code>/auth/</code>, <code>/login/</code>, <code>/logout/</code></td><td>ì¸ì¦ ê´€ë ¨ ì œì™¸</td></tr>
                    <tr><td>HTTP ë©”ì„œë“œ</td><td>GET, POST</td><td>ì¡°íšŒ ìš”ì²­ë§Œ</td></tr>
                    <tr><td>ì‘ë‹µ ìƒíƒœ</td><td>200~299</td><td>ì„±ê³µ ì‘ë‹µë§Œ</td></tr>
                    <tr><td>Content-Type</td><td><code>application/json</code></td><td>JSON ì‘ë‹µë§Œ</td></tr>
                    <tr><td>ì‘ë‹µ í¬ê¸°</td><td>&lt; 10MB</td><td>ëŒ€ìš©ëŸ‰ ì‘ë‹µ ìŠ¤í‚µ</td></tr>
                </tbody>
            </table>

            <h3>ì—ëŸ¬ ê²©ë¦¬ (PoC ê²€ì¦ ì™„ë£Œ)</h3>
            <div class="grid-2">
                <div class="highlight-box success">
                    <h4>fire-and-forget íŒ¨í„´</h4>
                    <p>ë¹„ë™ê¸° ì €ì¥ì´ ì™„ë£Œë˜ê¸° ì „ì— ì›ë³¸ ì‘ë‹µì´ ì¦‰ì‹œ ë°˜í™˜ë©ë‹ˆë‹¤.<br>ì˜¤ë²„í—¤ë“œ <strong>&lt; 1ms</strong></p>
                </div>
                <div class="highlight-box success">
                    <h4>ì—ëŸ¬ ê²©ë¦¬ 100%</h4>
                    <p>IndexedDB ì¥ì• , quota ì´ˆê³¼, JSON íŒŒì‹± ì‹¤íŒ¨ ì‹œì—ë„<br>ì›ë³¸ ì•± ë™ì‘ì— <strong>ì˜í–¥ ì—†ìŒ</strong></p>
                </div>
            </div>
        </div>

        <!-- Cache Manager -->
        <div class="card">
            <h2>Cache Manager â€” IndexedDB ê´€ë¦¬</h2>

            <h3>ë°ì´í„°ë² ì´ìŠ¤ ìŠ¤í‚¤ë§ˆ</h3>
            <div class="code-block">
Database: copilot-cache<br>
Store: api-responses<br><br>
Record {<br>
&nbsp;&nbsp;key: string &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// URL ê¸°ë°˜ í‚¤ (ì˜ˆ: "GET:/api/cost/summary")<br>
&nbsp;&nbsp;url: string &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// ì›ë³¸ URL<br>
&nbsp;&nbsp;method: string &nbsp;&nbsp;&nbsp;// HTTP ë©”ì„œë“œ<br>
&nbsp;&nbsp;data: any &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// API ì‘ë‹µ ë°ì´í„° (JSON)<br>
&nbsp;&nbsp;size: number &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// ë°ì´í„° í¬ê¸° (bytes)<br>
&nbsp;&nbsp;menu: string &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// í˜ì´ì§€ ë©”ë‰´ (ì˜ˆ: "/cost/")<br>
&nbsp;&nbsp;timestamp: number // ì €ì¥ ì‹œê° (ms)<br>
}<br><br>
Indexes: menu, timestamp
            </div>

            <h3>ê´€ë¦¬ ì •ì±…</h3>
            <table class="tech-table">
                <thead>
                    <tr><th>ì •ì±…</th><th>ê°’</th><th>ì„¤ëª…</th></tr>
                </thead>
                <tbody>
                    <tr><td>TTL</td><td><strong>5ë¶„</strong></td><td>ì €ì¥ í›„ 5ë¶„ ê²½ê³¼ ì‹œ ìë™ ë§Œë£Œ</td></tr>
                    <tr><td>MAX_ENTRIES</td><td><strong>100ê±´</strong></td><td>ì´ˆê³¼ ì‹œ ì˜¤ë˜ëœ í•­ëª©ë¶€í„° ì‚­ì œ</td></tr>
                    <tr><td>MAX_SIZE</td><td><strong>100MB</strong></td><td>ë‹¨ì¼ ì‘ë‹µ í¬ê¸° ìƒí•œ</td></tr>
                    <tr><td>DEDUP_INTERVAL</td><td><strong>1ì´ˆ</strong></td><td>ë™ì¼ URL ì¤‘ë³µ ì €ì¥ ë°©ì§€</td></tr>
                    <tr><td>ë®ì–´ì“°ê¸°</td><td>í•­ìƒ</td><td>ë™ì¼ í‚¤ â†’ ìµœì‹  ë°ì´í„°ë¡œ êµì²´</td></tr>
                    <tr><td>ë©”ë‰´ ë³€ê²½ ì‚­ì œ</td><td>ì¦‰ì‹œ</td><td>ì´ì „ ë©”ë‰´ ë°ì´í„° ì „ì²´ ì‚­ì œ</td></tr>
                </tbody>
            </table>

            <h3>ë©”ë‰´ ë³€ê²½ ê°ì§€</h3>
            <div class="mermaid-container">
                <div class="mermaid">
flowchart LR
    A["History API ë˜í•‘<br>(pushState, replaceState)<br>+ popstate"] --> B["ë©”ë‰´ ë³€ê²½ ê°ì§€"]
    B --> C["ì´ì „ ë©”ë‰´ ë°ì´í„° ì‚­ì œ<br>CopilotCache.deleteByMenu()"]
    C --> D["ìƒˆ ë©”ë‰´ API ì‘ë‹µ<br>ìë™ ì €ì¥"]

    style C fill:#fee2e2,stroke:#ef4444
    style D fill:#d1fae5,stroke:#10b981
                </div>
            </div>
        </div>

        <!-- WebSocket ì½œë°± -->
        <div class="card">
            <h2>WebSocket Handler â€” ì„œë²„ ì½œë°± ì²˜ë¦¬</h2>

            <h3>ì½œë°± íƒ€ì…</h3>
            <div class="grid-2">
                <div>
                    <h4 style="color: #10B981; margin-bottom: 10px;">Server â†’ Client</h4>
                    <div class="feature-item">
                        <span class="arrow-icon incoming">&larr;</span>
                        <span><code>request_available_data</code> IndexedDB í‚¤ ëª©ë¡ ìš”ì²­</span>
                    </div>
                    <div class="feature-item">
                        <span class="arrow-icon incoming">&larr;</span>
                        <span><code>request_api</code> íŠ¹ì • í‚¤ ë°ì´í„° ìš”ì²­</span>
                    </div>
                    <div class="feature-item">
                        <span class="arrow-icon incoming">&larr;</span>
                        <span><code>execute_code</code> LLM ìƒì„± ì½”ë“œ ì‹¤í–‰ ìš”ì²­</span>
                    </div>
                    <div class="feature-item">
                        <span class="arrow-icon incoming">&larr;</span>
                        <span><code>ping</code> í•˜íŠ¸ë¹„íŠ¸</span>
                    </div>
                </div>
                <div>
                    <h4 style="color: #3B82F6; margin-bottom: 10px;">Client â†’ Server</h4>
                    <div class="feature-item">
                        <span class="arrow-icon outgoing">&rarr;</span>
                        <span><code>available_data</code> í‚¤ ëª©ë¡ ì‘ë‹µ</span>
                    </div>
                    <div class="feature-item">
                        <span class="arrow-icon outgoing">&rarr;</span>
                        <span><code>api_result</code> ë°ì´í„° ì‘ë‹µ</span>
                    </div>
                    <div class="feature-item">
                        <span class="arrow-icon outgoing">&rarr;</span>
                        <span><code>code_result</code> ì½”ë“œ ì‹¤í–‰ ê²°ê³¼</span>
                    </div>
                    <div class="feature-item">
                        <span class="arrow-icon outgoing">&rarr;</span>
                        <span><code>pong</code> í•˜íŠ¸ë¹„íŠ¸ ì‘ë‹µ</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- ì½œë°± íë¦„ ì‹œí€€ìŠ¤ -->
        <div class="card">
            <h2>ì½œë°± íë¦„ ìƒì„¸</h2>

            <div class="flow-section">
                <div class="flow-card">
                    <h4>request_api íë¦„ (ì†Œìš©ëŸ‰)</h4>
                    <div class="mermaid">
sequenceDiagram
    participant S as Server
    participant C as Client

    S->>C: request_available_data
    C->>S: available_data {í‚¤ ëª©ë¡}
    Note over S: LLMì´ í‚¤ ì„ íƒ
    S->>C: request_api {dataKey}
    Note over C: IndexedDB ì¡°íšŒ
    C->>S: api_result {data}
    Note over S: LLM ì‘ë‹µ ìƒì„±
    S->>C: response {answer}
                    </div>
                </div>
                <div class="flow-card">
                    <h4>execute_code íë¦„ (ëŒ€ìš©ëŸ‰)</h4>
                    <div class="mermaid">
sequenceDiagram
    participant S as Server
    participant C as Client

    S->>C: request_available_data
    C->>S: available_data {í‚¤ ëª©ë¡}
    Note over S: LLMì´ JS ì½”ë“œ ìƒì„±<br>(CopilotCache.get í¬í•¨)
    S->>C: execute_code {code}
    Note over C: ì½”ë“œ ì‹¤í–‰<br>â†’ í•„ìš” ë°ì´í„° ì¶”ì¶œ
    C->>S: code_result {result}
    Note over S: LLM ì‘ë‹µ ìƒì„±
    S->>C: response {answer}
                    </div>
                </div>
            </div>

            <div class="highlight-box">
                <h4>execute_code í•µì‹¬ íŠ¹ì„±</h4>
                <p>
                    <strong>ìì²´ ì™„ê²°í˜• ì½”ë“œ:</strong> ì„œë²„(LLM)ê°€ available_data ìŠ¤í‚¤ë§ˆë¥¼ ë³´ê³  ì½”ë“œ ìƒì„± (CopilotCache.get() í˜¸ì¶œ í¬í•¨)<br>
                    <strong>í´ë¼ì´ì–¸íŠ¸ ì—­í• :</strong> ì½”ë“œë§Œ ì‹¤í–‰ â€” ì–´ë–¤ í‚¤ë¥¼ ì¡°íšŒí• ì§€ ì•Œ í•„ìš” ì—†ìŒ<br>
                    <strong>ì•½ì†ëœ ì¸í„°í˜ì´ìŠ¤:</strong> <code>CopilotCache.get(key)</code>, <code>CopilotCache.getAll()</code>, <code>CopilotCache.getByMenu(menu)</code>
                </p>
            </div>
        </div>

        <!-- ì „ì²´ ë°ì´í„° íë¦„ -->
        <div class="card">
            <h2>ì „ì²´ ë°ì´í„° íë¦„</h2>

            <div class="mermaid-container">
                <div class="mermaid">
sequenceDiagram
    participant U as ì‚¬ìš©ì
    participant App as OpsNow App
    participant Hook as Network Hook
    participant DB as IndexedDB
    participant WS as WS Handler
    participant S as Copilot Server

    U->>App: /cost/ í˜ì´ì§€ ì ‘ì†
    App->>Hook: Axios ì‘ë‹µ (Interceptor)
    Hook-->>DB: fire-and-forget ì €ì¥
    Hook->>App: ì›ë³¸ ì‘ë‹µ ë°˜í™˜ (< 1ms)

    U->>WS: "ì´ë²ˆë‹¬ ë¹„ìš©ì´ ì–¼ë§ˆì•¼?"
    WS->>S: query {query, domContext}

    S->>WS: request_available_data
    WS->>DB: getAll()
    DB->>WS: [í‚¤ ëª©ë¡]
    WS->>S: available_data

    S->>WS: request_api {dataKey}
    WS->>DB: get(dataKey)
    DB->>WS: {data}
    WS->>S: api_result

    S->>WS: response {answer}
    WS->>U: ë‹µë³€ í‘œì‹œ
                </div>
            </div>
        </div>

        <!-- execute_code ë³´ì•ˆ -->
        <div class="card">
            <h2>execute_code ì‹¤í–‰ í™˜ê²½</h2>

            <div class="grid-2">
                <div>
                    <h3>PoC</h3>
                    <div class="feature-item">
                        <span class="arrow-icon storage">F</span>
                        <span><code>new Function('CopilotCache', code)</code></span>
                    </div>
                    <div class="feature-item">
                        <span class="check">âœ“</span>
                        <span>CopilotCacheë§Œ ì ‘ê·¼ ê°€ëŠ¥</span>
                    </div>
                    <div class="feature-item">
                        <span class="check">âœ“</span>
                        <span>try-catch ì—ëŸ¬ ê²©ë¦¬</span>
                    </div>
                    <div class="feature-item">
                        <span class="check">âœ“</span>
                        <span>10ì´ˆ íƒ€ì„ì•„ì›ƒ</span>
                    </div>
                </div>
                <div>
                    <h3>í”„ë¡œë•ì…˜</h3>
                    <div class="feature-item">
                        <span class="arrow-icon storage">W</span>
                        <span>Web Worker / iframe sandbox</span>
                    </div>
                    <div class="feature-item">
                        <span class="check">âœ“</span>
                        <span>ë³„ë„ ìŠ¤ë ˆë“œ ì‹¤í–‰</span>
                    </div>
                    <div class="feature-item">
                        <span class="check">âœ“</span>
                        <span>DOM ì ‘ê·¼ ì›ì²œ ì°¨ë‹¨</span>
                    </div>
                    <div class="feature-item">
                        <span class="check">âœ“</span>
                        <span>ë©”ëª¨ë¦¬/CPU ì œí•œ</span>
                    </div>
                </div>
            </div>

            <div class="highlight-box danger">
                <h4>ë³´ì•ˆ ìœ„í˜‘ ëŒ€ì‘</h4>
                <p>
                    <strong>ì•…ì„± ì½”ë“œ:</strong> CopilotCacheë§Œ ì ‘ê·¼ ê°€ëŠ¥ (window, document ì°¨ë‹¨)<br>
                    <strong>ë¬´í•œ ë£¨í”„:</strong> íƒ€ì„ì•„ì›ƒ 10ì´ˆ<br>
                    <strong>ì—ëŸ¬ ì „íŒŒ:</strong> try-catch â†’ code_result.success=false ë°˜í™˜, ì›ë³¸ í˜ì´ì§€ ì˜í–¥ ì—†ìŒ
                </p>
            </div>
        </div>

        <!-- ì„±ëŠ¥ -->
        <div class="card">
            <h2>ì„±ëŠ¥ (PoC ê²€ì¦ ê²°ê³¼)</h2>

            <div class="grid-4">
                <div class="info-card">
                    <div class="icon">1KB</div>
                    <h4>x 100ê±´</h4>
                    <p>&lt; 1ms ì˜¤ë²„í—¤ë“œ</p>
                    <span class="badge-inline badge-green">Pass</span>
                </div>
                <div class="info-card">
                    <div class="icon">100KB</div>
                    <h4>x 20ê±´</h4>
                    <p>&lt; 1ms ì˜¤ë²„í—¤ë“œ</p>
                    <span class="badge-inline badge-green">Pass</span>
                </div>
                <div class="info-card">
                    <div class="icon">5MB</div>
                    <h4>x 5ê±´</h4>
                    <p>&lt; 1ms ì˜¤ë²„í—¤ë“œ</p>
                    <span class="badge-inline badge-green">Pass</span>
                </div>
                <div class="info-card">
                    <div class="icon">10ê±´</div>
                    <h4>ë™ì‹œ ìš”ì²­</h4>
                    <p>ì „ê±´ ì •ìƒ ì €ì¥</p>
                    <span class="badge-inline badge-green">Pass</span>
                </div>
            </div>

            <h3>ë©”ì‹œì§€ í¬ê¸° ì œí•œ</h3>
            <table class="tech-table">
                <thead>
                    <tr><th>ë©”ì‹œì§€</th><th>ê¶Œì¥ ìµœëŒ€</th><th>ë¹„ê³ </th></tr>
                </thead>
                <tbody>
                    <tr><td><code>available_data</code></td><td>10KB</td><td>í‚¤ ëª©ë¡</td></tr>
                    <tr><td><code>api_result</code></td><td>100KB</td><td>ì´ˆê³¼ ì‹œ execute_code ì „í™˜</td></tr>
                    <tr><td><code>code_result</code></td><td>1KB</td><td>ì¶”ì¶œ ê²°ê³¼ë§Œ</td></tr>
                </tbody>
            </table>
        </div>

        <!-- One-Time Token -->
        <div class="card">
            <h2>ë³´ì•ˆ â€” One-Time Token</h2>

            <div class="flow-step">
                <div class="number">1</div>
                <div class="content">
                    <h4>í† í° ë°œê¸‰</h4>
                    <p>ì„œë²„ê°€ ì½œë°± ìš”ì²­ ì‹œ ì¼íšŒìš© requestId ìƒì„± (timestamp + random)</p>
                </div>
            </div>
            <div class="flow-step">
                <div class="number">2</div>
                <div class="content">
                    <h4>ì‘ë‹µ ì²¨ë¶€</h4>
                    <p>í´ë¼ì´ì–¸íŠ¸ê°€ ì‘ë‹µ ì‹œ ë°›ì€ requestIdë¥¼ ê·¸ëŒ€ë¡œ ì²¨ë¶€</p>
                </div>
            </div>
            <div class="flow-step">
                <div class="number">3</div>
                <div class="content">
                    <h4>ê²€ì¦ ë° íê¸°</h4>
                    <p>ì„œë²„ê°€ Future resolve í›„ ì¦‰ì‹œ íê¸° (1íšŒìš©)</p>
                </div>
            </div>

            <table class="tech-table" style="margin-top: 20px;">
                <thead>
                    <tr><th>ìœ„í˜‘</th><th>ëŒ€ì‘</th><th>íš¨ê³¼</th></tr>
                </thead>
                <tbody>
                    <tr>
                        <td>Replay Attack</td>
                        <td>ì‚¬ìš© ì¦‰ì‹œ íê¸°</td>
                        <td><span class="badge-inline badge-green">ì™„ì „ ì°¨ë‹¨</span></td>
                    </tr>
                    <tr>
                        <td>í† í° ì˜ˆì¸¡</td>
                        <td><code>secrets.token_urlsafe</code></td>
                        <td><span class="badge-inline badge-green">ì•”í˜¸í•™ì  ì•ˆì „</span></td>
                    </tr>
                    <tr>
                        <td>ìœ„ì¡° ì‘ë‹µ ì£¼ì…</td>
                        <td>ë“±ë¡ëœ requestIdë§Œ ìˆ˜ë½</td>
                        <td><span class="badge-inline badge-green">ê±°ë¶€</span></td>
                    </tr>
                </tbody>
            </table>
        </div>

        <!-- êµ¬í˜„ í•­ëª© -->
        <div class="card">
            <h2>êµ¬í˜„ í•­ëª© ì •ë¦¬</h2>

            <h3>í´ë¼ì´ì–¸íŠ¸ ëª¨ë“ˆ (PoC â†’ í”„ë¡œë•ì…˜)</h3>
            <table class="tech-table">
                <thead>
                    <tr><th>ëª¨ë“ˆ</th><th>PoC ì™„ë£Œ</th><th>í”„ë¡œë•ì…˜ ì¶”ê°€ ì‘ì—…</th></tr>
                </thead>
                <tbody>
                    <tr>
                        <td><code>copilot-cache.js</code></td>
                        <td>IndexedDB CRUD + ê´€ë¦¬ ì •ì±…</td>
                        <td>TypeScript ì „í™˜, ì„¤ì • ì™¸ë¶€í™”</td>
                    </tr>
                    <tr>
                        <td><code>copilot-network-hook.js</code></td>
                        <td>fetch/XHR ì˜¤ë²„ë¼ì´ë“œ + í•„í„°ë§</td>
                        <td><strong>Axios Interceptorë¡œ ì „í™˜</strong> (ê³µí†µ axios í†µì¼ í›„)</td>
                    </tr>
                    <tr>
                        <td><code>copilot-ws-handler.js</code></td>
                        <td>WebSocket ì½œë°± ì²˜ë¦¬</td>
                        <td>Web Worker sandbox, ì¬ì—°ê²°</td>
                    </tr>
                </tbody>
            </table>

            <h3>ì„œë²„ ëª¨ë“ˆ (ì‹ ê·œ êµ¬í˜„)</h3>
            <table class="tech-table">
                <thead>
                    <tr><th>ëª¨ë“ˆ</th><th>ì„¤ëª…</th></tr>
                </thead>
                <tbody>
                    <tr><td>WebSocket ì—”ë“œí¬ì¸íŠ¸</td><td>FastAPI WebSocket + PendingCallbacks</td></tr>
                    <tr><td>ì½œë°± ìš”ì²­ í•¨ìˆ˜</td><td><code>request_available_data()</code>, <code>request_api()</code>, <code>execute_code()</code></td></tr>
                    <tr><td>LLM ì½”ë“œ ìƒì„±</td><td>available_data ìŠ¤í‚¤ë§ˆ ê¸°ë°˜ JS ì½”ë“œ ìƒì„± í”„ë¡¬í”„íŠ¸</td></tr>
                    <tr><td>Smart Fallback</td><td>IndexedDB ë°ì´í„° ì—†ì„ ë•Œ ê´€ë ¨ ë©”ë‰´ ì•ˆë‚´</td></tr>
                </tbody>
            </table>

            <div class="highlight-box warning">
                <h4>Axios Interceptor ì „í™˜ ê³„íš</h4>
                <p>
                    ê³µí†µ axios (<code>getAxios()</code>) í†µì¼ í›„ Network Hookì„ Axios Interceptorë¡œ ì „í™˜ ì˜ˆì •.<br>
                    <strong>êµì²´ ëŒ€ìƒ:</strong> <code>copilot-network-hook.js</code> 1ê°œ ëª¨ë“ˆë§Œ<br>
                    <strong>ë³€ê²½ ì—†ìŒ:</strong> <code>copilot-cache.js</code>, <code>copilot-ws-handler.js</code>, ì„œë²„ ì „ì²´
                </p>
            </div>
        </div>

        <!-- í•µì‹¬ ì •ë¦¬ -->
        <div class="card">
            <h2>í•µì‹¬ ì •ë¦¬</h2>

            <div class="feature-item">
                <span class="check">1</span>
                <span><strong>Network Hook</strong> â€” Axios Interceptorë¡œ API ì‘ë‹µ ìë™ ìºì‹± (PoC: fetch/XHR Override â†’ ì „í™˜ ì˜ˆì •)</span>
            </div>
            <div class="feature-item">
                <span class="check">2</span>
                <span><strong>IndexedDB ê´€ë¦¬</strong> â€” TTL, ìš©ëŸ‰, ì¤‘ë³µ ë°©ì§€, ë©”ë‰´ë³„ ë¶„ë¦¬ ì •ì±…</span>
            </div>
            <div class="feature-item">
                <span class="check">3</span>
                <span><strong>WebSocket ì½œë°±</strong> â€” ì„œë²„ê°€ í´ë¼ì´ì–¸íŠ¸ IndexedDB ë°ì´í„°ë¥¼ ìš”ì²­/ì¡°íšŒ/ì½”ë“œ ì‹¤í–‰</span>
            </div>
            <div class="feature-item">
                <span class="check">4</span>
                <span><strong>execute_code</strong> â€” LLMì´ ìƒì„±í•œ ìì²´ ì™„ê²°í˜• ì½”ë“œë¥¼ í´ë¼ì´ì–¸íŠ¸ì—ì„œ ì‹¤í–‰ (ëŒ€ìš©ëŸ‰ ë°ì´í„° ì²˜ë¦¬)</span>
            </div>
            <div class="feature-item">
                <span class="check">5</span>
                <span><strong>ì—ëŸ¬ ê²©ë¦¬ 100%</strong> â€” ìºì‹œ ì¥ì• , ì½”ë“œ ì‹¤í–‰ ì—ëŸ¬ ì‹œì—ë„ ì›ë³¸ ì•± ì˜í–¥ ì—†ìŒ</span>
            </div>
            <div class="feature-item">
                <span class="check">6</span>
                <span><strong>ì„±ëŠ¥ ë¬´ì˜í–¥</strong> â€” fire-and-forget íŒ¨í„´, ì˜¤ë²„í—¤ë“œ &lt; 1ms</span>
            </div>
        </div>

        <footer>
            <p>OpsNow Copilot - IndexedDB Cache Design Document</p>
            <p>PoC: IndexedDB Cache (Phase 1~4)</p>
        </footer>
    </div>

    <script>
        mermaid.initialize({
            startOnLoad: true,
            theme: 'default',
            securityLevel: 'loose',
            flowchart: {
                useMaxWidth: true,
                htmlLabels: true,
                curve: 'basis'
            },
            sequence: {
                useMaxWidth: true,
                showSequenceNumbers: false
            }
        });
    </script>
</body>
</html>
