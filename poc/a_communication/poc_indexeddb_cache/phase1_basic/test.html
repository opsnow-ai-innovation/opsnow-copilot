<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>Phase 1 — Network Override + IndexedDB 기본 테스트</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: 'Consolas', 'Menlo', monospace; background: #1e1e2e; color: #cdd6f4; padding: 20px; }
    h1 { color: #89b4fa; margin-bottom: 8px; font-size: 20px; }
    h2 { color: #a6e3a1; margin: 20px 0 10px; font-size: 16px; }
    .subtitle { color: #6c7086; font-size: 13px; margin-bottom: 20px; }

    .section { background: #313244; border-radius: 8px; padding: 16px; margin-bottom: 16px; }
    .section-title { color: #f5c2e7; font-size: 14px; font-weight: bold; margin-bottom: 12px; }
    .section-desc { color: #6c7086; font-size: 11px; margin-bottom: 10px; line-height: 1.5; }
    .guide { color: #9399b2; font-size: 11px; margin-top: 8px; line-height: 1.5; }

    button {
      background: #45475a; color: #cdd6f4; border: 1px solid #585b70;
      padding: 8px 16px; border-radius: 6px; cursor: pointer; font-family: inherit;
      font-size: 13px; margin: 4px;
    }
    button:hover { background: #585b70; }
    button.primary { background: #89b4fa; color: #1e1e2e; border-color: #89b4fa; font-weight: bold; }
    button.danger { background: #f38ba8; color: #1e1e2e; border-color: #f38ba8; }

    #log {
      background: #11111b; border: 1px solid #313244; border-radius: 8px;
      padding: 12px; height: 400px; overflow-y: auto; font-size: 12px;
      line-height: 1.6; white-space: pre-wrap; word-break: break-all;
    }
    .log-info { color: #89b4fa; }
    .log-success { color: #a6e3a1; }
    .log-warn { color: #f9e2af; }
    .log-error { color: #f38ba8; }
    .log-data { color: #cba6f7; }

    table { width: 100%; border-collapse: collapse; margin-top: 8px; font-size: 12px; }
    th { background: #45475a; padding: 6px 8px; text-align: left; color: #89b4fa; }
    td { padding: 6px 8px; border-bottom: 1px solid #313244; }
    tr:hover td { background: #45475a; }

    #cache-table { margin-top: 12px; }
  </style>
</head>
<body>

<h1>Phase 1: Network Override + IndexedDB 기본 테스트</h1>
<p class="subtitle">fetch/XHR 오버라이드 → IndexedDB 저장/조회 검증 | Mock API: http://localhost:3456</p>

<!-- 1. fetch 테스트 -->
<div class="section">
  <div class="section-title">1-1. fetch Override 테스트</div>
  <div class="section-desc">window.fetch를 래핑하여 API 응답을 가로채고 IndexedDB에 저장하는지 확인합니다. 순서 무관, 개별 실행 가능.</div>
  <button class="primary" onclick="testFetchGet()">fetch GET /api/cost/summary</button>
  <button onclick="testFetchPost()">fetch POST /api/cost/detail</button>
  <button onclick="testFetchNonTarget()">fetch GET /auth/token (비대상)</button>
  <p class="guide">확인: 각 버튼 클릭 후 → 하단 [캐시 조회]로 IndexedDB에 저장됐는지 확인. 비대상 URL은 저장되지 않아야 함.</p>
</div>

<!-- 2. XHR 테스트 -->
<div class="section">
  <div class="section-title">1-2. XHR Override 테스트</div>
  <div class="section-desc">XMLHttpRequest.prototype을 래핑하여 XHR 기반 요청도 가로채는지 확인합니다. 순서 무관, 개별 실행 가능.</div>
  <button class="primary" onclick="testXhrGet()">XHR GET /api/asset/list</button>
  <button onclick="testXhrPost()">XHR POST /api/asset/detail</button>
  <button onclick="testXhrNonTarget()">XHR GET /auth/token (비대상)</button>
  <p class="guide">확인: fetch와 동일하게 IndexedDB 저장 여부 확인. XHR은 prototype 오버라이드이므로 로드 순서 무관.</p>
</div>

<!-- 3. Axios adapter 테스트 -->
<div class="section">
  <div class="section-title">1-3. Axios adapter 확인 테스트</div>
  <div class="section-desc">Axios가 내부적으로 fetch/XHR 중 어느 것을 사용하는지 확인하고, 각 경로에서 override가 동작하는지 검증합니다.</div>
  <button class="primary" onclick="testAxiosDefault()">Axios 기본 요청</button>
  <button onclick="testAxiosXhr()">Axios adapter: xhr</button>
  <button onclick="testAxiosFetch()">Axios adapter: fetch</button>
  <p class="guide">
    · 기본 요청: Axios가 자동 선택하는 adapter(보통 xhr)로 요청<br>
    · adapter: xhr → XHR override 트리거, adapter: fetch → fetch override 트리거<br>
    · 핵심: copilot-network-hook.js가 Axios보다 먼저 로드되어야 fetch adapter override가 동작함
  </p>
</div>

<!-- 4. IndexedDB 조회 -->
<div class="section">
  <div class="section-title">IndexedDB 캐시 확인</div>
  <div class="section-desc">위 테스트 실행 후 여기서 저장된 데이터를 확인합니다. 다른 테스트 전에 [전체 삭제]로 초기화하면 결과를 깔끔하게 볼 수 있습니다.</div>
  <button class="primary" onclick="refreshCacheView()">캐시 조회</button>
  <button class="danger" onclick="clearCache()">전체 삭제</button>
  <div id="cache-table"></div>
</div>

<!-- 로그 -->
<h2>실행 로그</h2>
<div id="log"></div>
<button style="margin-top:8px" onclick="document.getElementById('log').innerHTML=''">로그 지우기</button>

<!-- 스크립트 로드: network hook을 Axios보다 먼저 로드해야 fetch override가 적용됨 -->
<script src="copilot-cache.js"></script>
<script src="copilot-network-hook.js"></script>
<script src="https://cdn.jsdelivr.net/npm/axios@1.7.9/dist/axios.min.js"></script>

<script>
const API_BASE = ''; // 같은 origin (http://localhost:3456)
const logEl = document.getElementById('log');

function log(msg, type = 'info') {
  const ts = new Date().toLocaleTimeString();
  const line = document.createElement('div');
  line.className = `log-${type}`;
  line.textContent = `[${ts}] ${msg}`;
  logEl.appendChild(line);
  logEl.scrollTop = logEl.scrollHeight;
}

function logData(label, data) {
  log(`${label}: ${JSON.stringify(data, null, 2)}`, 'data');
}

// ─── 1-1. fetch 테스트 ───

async function testFetchGet() {
  log('▶ fetch GET /api/cost/summary', 'info');
  try {
    const res = await fetch(`${API_BASE}/api/cost/summary`);
    const data = await res.json();
    logData('응답', data);
    log(`✓ status: ${res.status}, 원본 응답 정상 반환`, 'success');
  } catch (err) {
    log(`✗ 에러: ${err.message}`, 'error');
  }
}

async function testFetchPost() {
  log('▶ fetch POST /api/cost/detail', 'info');
  try {
    const res = await fetch(`${API_BASE}/api/cost/detail`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ period: '2025-01' }),
    });
    const data = await res.json();
    logData('응답', data);
    log(`✓ status: ${res.status}, 원본 응답 정상 반환`, 'success');
  } catch (err) {
    log(`✗ 에러: ${err.message}`, 'error');
  }
}

async function testFetchNonTarget() {
  log('▶ fetch GET /auth/token (비대상 URL)', 'info');
  try {
    const res = await fetch(`${API_BASE}/auth/token`);
    const data = await res.json();
    logData('응답', data);
    log('✓ 비대상 URL — IndexedDB에 저장되지 않아야 함', 'warn');
  } catch (err) {
    log(`✗ 에러: ${err.message}`, 'error');
  }
}

// ─── 1-2. XHR 테스트 ───

function testXhrGet() {
  log('▶ XHR GET /api/asset/list', 'info');
  const xhr = new XMLHttpRequest();
  xhr.open('GET', `${API_BASE}/api/asset/list`);
  xhr.onload = function () {
    const data = JSON.parse(xhr.responseText);
    logData('응답', data);
    log(`✓ status: ${xhr.status}, 원본 응답 정상 반환`, 'success');
  };
  xhr.onerror = function () {
    log('✗ XHR 에러', 'error');
  };
  xhr.send();
}

function testXhrPost() {
  log('▶ XHR POST /api/asset/detail', 'info');
  const xhr = new XMLHttpRequest();
  xhr.open('POST', `${API_BASE}/api/asset/detail`);
  xhr.setRequestHeader('Content-Type', 'application/json');
  xhr.onload = function () {
    const data = JSON.parse(xhr.responseText);
    logData('응답', data);
    log(`✓ status: ${xhr.status}, 원본 응답 정상 반환`, 'success');
  };
  xhr.onerror = function () {
    log('✗ XHR 에러', 'error');
  };
  xhr.send(JSON.stringify({ id: 'i-abc123' }));
}

function testXhrNonTarget() {
  log('▶ XHR GET /auth/token (비대상 URL)', 'info');
  const xhr = new XMLHttpRequest();
  xhr.open('GET', `${API_BASE}/auth/token`);
  xhr.onload = function () {
    const data = JSON.parse(xhr.responseText);
    logData('응답', data);
    log('✓ 비대상 URL — IndexedDB에 저장되지 않아야 함', 'warn');
  };
  xhr.onerror = function () {
    log('✗ XHR 에러', 'error');
  };
  xhr.send();
}

// ─── 1-3. Axios 테스트 ───

async function testAxiosDefault() {
  log('▶ Axios 기본 요청 GET /api/billing/overview', 'info');
  try {
    const res = await axios.get(`${API_BASE}/api/billing/overview`);
    logData('응답', res.data);
    log(`✓ status: ${res.status}`, 'success');
  } catch (err) {
    log(`✗ 에러: ${err.message}`, 'error');
  }
}

async function testAxiosXhr() {
  log('▶ Axios adapter: xhr — GET /api/cost/summary', 'info');
  try {
    const res = await axios.get(`${API_BASE}/api/cost/summary`, { adapter: 'xhr' });
    logData('응답', res.data);
    log(`✓ status: ${res.status}, adapter: xhr`, 'success');
  } catch (err) {
    log(`✗ 에러: ${err.message}`, 'error');
  }
}

async function testAxiosFetch() {
  log('▶ Axios adapter: fetch — GET /api/cost/summary', 'info');
  try {
    const res = await axios.get(`${API_BASE}/api/cost/summary`, { adapter: 'fetch' });
    logData('응답', res.data);
    log(`✓ status: ${res.status}, adapter: fetch`, 'success');
  } catch (err) {
    log(`✗ 에러: ${err.message}`, 'error');
  }
}

// ─── IndexedDB 캐시 조회 ───

async function refreshCacheView() {
  log('▶ IndexedDB 캐시 조회', 'info');
  try {
    const records = await CopilotCache.getAll();
    const container = document.getElementById('cache-table');

    if (records.length === 0) {
      container.innerHTML = '<p style="color:#6c7086; margin-top:8px;">저장된 데이터 없음</p>';
      log(`캐시: 0건`, 'warn');
      return;
    }

    let html = `<table>
      <tr><th>#</th><th>Key</th><th>Method</th><th>Status</th><th>Menu</th><th>Time</th><th>Data (preview)</th></tr>`;

    records.forEach((r, i) => {
      const preview = JSON.stringify(r.data).substring(0, 80) + '...';
      const time = new Date(r.timestamp).toLocaleTimeString();
      html += `<tr>
        <td>${i + 1}</td>
        <td>${r.key}</td>
        <td>${r.method}</td>
        <td>${r.status}</td>
        <td>${r.menu}</td>
        <td>${time}</td>
        <td style="color:#cba6f7">${preview}</td>
      </tr>`;
    });

    html += '</table>';
    container.innerHTML = html;
    log(`✓ 캐시: ${records.length}건 조회`, 'success');
  } catch (err) {
    log(`✗ 캐시 조회 실패: ${err.message}`, 'error');
  }
}

async function clearCache() {
  try {
    await CopilotCache.clear();
    document.getElementById('cache-table').innerHTML =
      '<p style="color:#6c7086; margin-top:8px;">저장된 데이터 없음</p>';
    log('✓ 캐시 전체 삭제 완료', 'success');
  } catch (err) {
    log(`✗ 캐시 삭제 실패: ${err.message}`, 'error');
  }
}

// 초기 로그
log('Phase 1 테스트 페이지 로드 완료', 'success');
log('Mock API 서버가 http://localhost:3456 에서 실행 중이어야 합니다', 'warn');
</script>

</body>
</html>
