<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebSocket PoC - Phase 5 (멀티 유저)</title>
    <style>
        * {
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }
        body {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        h1 { color: #333; }
        h3 { margin-top: 0; color: #555; }

        .section {
            background: white;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .settings-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            margin-right: 8px;
        }
        .settings-badge.on { background: #e8f5e9; color: #2e7d32; }
        .settings-badge.off { background: #ffebee; color: #c62828; }

        .controls {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin: 10px 0;
        }
        button {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
        }
        button:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn-primary { background: #2196f3; color: white; }
        .btn-success { background: #4caf50; color: white; }
        .btn-danger { background: #f44336; color: white; }
        .btn-warning { background: #ff9800; color: white; }
        .btn-secondary { background: #9e9e9e; color: white; }

        .user-panel {
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
        }
        .user-panel.connected { border-color: #4caf50; }
        .user-panel.disconnected { border-color: #9e9e9e; }

        .user-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        .user-name {
            font-weight: bold;
            font-size: 16px;
        }
        .user-status {
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
        }
        .user-status.connected { background: #e8f5e9; color: #2e7d32; }
        .user-status.disconnected { background: #f5f5f5; color: #757575; }

        .user-info {
            font-size: 12px;
            color: #666;
            margin-bottom: 10px;
        }

        .dashboard {
            background: #e3f2fd;
            border: 2px solid #2196f3;
            border-radius: 8px;
            padding: 15px;
        }
        .dashboard h4 { margin: 0 0 15px 0; color: #1565c0; }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-bottom: 15px;
        }
        .stat-card {
            background: white;
            padding: 15px;
            border-radius: 6px;
            text-align: center;
        }
        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #1565c0;
        }
        .stat-label {
            font-size: 12px;
            color: #666;
        }

        .connection-list {
            background: white;
            border-radius: 6px;
            max-height: 200px;
            overflow-y: auto;
        }
        .connection-item {
            padding: 10px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            font-size: 13px;
        }
        .connection-item:last-child { border-bottom: none; }

        #log {
            height: 200px;
            overflow-y: auto;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 12px;
            line-height: 1.5;
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 15px;
            border-radius: 6px;
        }
        .log-entry { margin-bottom: 4px; padding: 2px 0; border-bottom: 1px solid #333; }
        .log-time { color: #6a9955; }
        .log-send { color: #569cd6; }
        .log-receive { color: #ce9178; }
        .log-info { color: #dcdcaa; }
        .log-error { color: #f44747; }
        .log-success { color: #4ec9b0; }

        .test-panel {
            background: #fff3e0;
            border: 2px solid #ff9800;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
        }
        .test-panel h4 { margin: 0 0 10px 0; color: #e65100; }

        select, input {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <h1>WebSocket PoC - Phase 5: 멀티 유저</h1>
    <p style="color: #666; margin-top: -10px;">동일 사용자 다중 연결, Rate Limit 공유 정책, 동시 요청 검증</p>

    <!-- 서버 설정 표시 -->
    <div class="section">
        <h3>서버 설정</h3>
        <div>
            <span class="settings-badge" id="multiConnBadge">SINGLE_SESSION_PER_USER: -</span>
            <span class="settings-badge" id="rateLimitBadge">SHARE_RATE_LIMIT: -</span>
        </div>
        <p style="font-size: 12px; color: #666; margin-top: 10px;">
            서버 설정을 변경하려면 server.py의 설정값을 수정하고 서버를 재시작하세요.
        </p>
    </div>

    <!-- 연결 대시보드 -->
    <div class="section dashboard">
        <h4>연결 대시보드</h4>
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-value" id="totalUsers">0</div>
                <div class="stat-label">접속 사용자</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="totalConnections">0</div>
                <div class="stat-label">총 연결 수</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="localConnections">0</div>
                <div class="stat-label">이 페이지 연결</div>
            </div>
        </div>
        <div class="connection-list" id="connectionList">
            <div class="connection-item" style="color: #999;">연결 정보 없음</div>
        </div>
        <div class="controls" style="margin-top: 10px;">
            <button class="btn-secondary" onclick="refreshDashboard()">새로고침</button>
        </div>
    </div>

    <!-- 사용자 패널 컨테이너 -->
    <div id="userPanels"></div>

    <!-- 사용자 추가 -->
    <div class="section">
        <h3>사용자 추가</h3>
        <div class="controls">
            <input type="text" id="newUsername" placeholder="이메일 (예: user_a@test.com)" style="width: 200px;">
            <input type="text" id="newName" placeholder="이름 (예: 사용자 A)" style="width: 150px;">
            <button class="btn-primary" onclick="addUser()">사용자 추가</button>
            <button class="btn-success" onclick="addUser('user_a@test.com', '사용자 A')">User A 추가</button>
            <button class="btn-success" onclick="addUser('user_b@test.com', '사용자 B')">User B 추가</button>
        </div>
    </div>

    <!-- 테스트 패널 -->
    <div class="section">
        <h3>5-1. 동일 사용자 다중 연결 테스트</h3>
        <p style="color: #666; font-size: 13px;">같은 사용자로 여러 번 연결했을 때 동작 확인</p>
        <div class="test-panel">
            <h4>테스트 방법</h4>
            <ol style="font-size: 13px; margin: 0; padding-left: 20px;">
                <li>"User A 추가" 버튼을 2번 클릭</li>
                <li>SINGLE_SESSION_PER_USER=False (다중 연결 허용): 두 연결 모두 유지</li>
                <li>SINGLE_SESSION_PER_USER=True (단일 연결만): 기존 연결 끊기고 새 연결만 유지</li>
            </ol>
        </div>
    </div>

    <div class="section">
        <h3>5-2. Rate Limit 공유 테스트</h3>
        <p style="color: #666; font-size: 13px;">동일 사용자 다중 연결 시 Rate Limit 공유 여부</p>
        <div class="test-panel">
            <h4>테스트 방법</h4>
            <ol style="font-size: 13px; margin: 0; padding-left: 20px;">
                <li>User A로 2개 연결 생성</li>
                <li>첫 번째 연결에서 요청 5회 전송</li>
                <li>두 번째 연결에서 요청 확인</li>
                <li>SHARE_RATE_LIMIT=True: 두 번째 연결도 남은 횟수 5회 (사용자 공유)</li>
                <li>SHARE_RATE_LIMIT=False: 두 번째 연결은 남은 횟수 10회 (연결별 별도)</li>
            </ol>
        </div>
    </div>

    <div class="section">
        <h3>5-3. 동시 요청 테스트</h3>
        <p style="color: #666; font-size: 13px;">여러 사용자가 동시에 요청 시 독립 처리 확인</p>
        <div class="controls">
            <button class="btn-warning" onclick="sendSimultaneousRequests()">모든 연결에서 동시 요청</button>
        </div>
    </div>

    <!-- 통신 로그 -->
    <div class="section">
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <h3>통신 로그</h3>
            <button class="btn-secondary" onclick="clearLog()" style="padding: 5px 10px; font-size: 12px;">로그 지우기</button>
        </div>
        <div id="log"></div>
    </div>

    <script>
        const SERVER_URL = 'http://localhost:8000';
        const WS_URL = 'ws://localhost:8000/ws/copilot';

        // 사용자별 연결 관리
        const users = new Map();  // panelId -> { username, name, token, ws, connectionId, ... }
        let panelCounter = 0;
        let queryCounter = 0;  // 전역 요청 카운터

        const logEl = document.getElementById('log');

        // ===========================================
        // 로그
        // ===========================================

        function addLog(type, message, username = '') {
            const time = new Date().toLocaleTimeString('ko-KR');
            const entry = document.createElement('div');
            entry.className = 'log-entry';
            let typeClass = 'log-info';
            let prefix = '';
            if (type === 'send') { typeClass = 'log-send'; prefix = '>>> '; }
            if (type === 'receive') { typeClass = 'log-receive'; prefix = '<<< '; }
            if (type === 'error') { typeClass = 'log-error'; prefix = '!!! '; }
            if (type === 'success') { typeClass = 'log-success'; prefix = 'OK '; }

            const userPrefix = username ? `[${username}] ` : '';
            entry.innerHTML = `<span class="log-time">[${time}]</span> <span class="${typeClass}">${prefix}${userPrefix}${escapeHtml(message)}</span>`;
            logEl.appendChild(entry);
            logEl.scrollTop = logEl.scrollHeight;
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function clearLog() {
            logEl.innerHTML = '';
        }

        // ===========================================
        // 대시보드
        // ===========================================

        async function refreshDashboard() {
            try {
                const response = await fetch(`${SERVER_URL}/api/connections`);
                const data = await response.json();

                // 설정 표시
                const multiConnBadge = document.getElementById('multiConnBadge');
                const rateLimitBadge = document.getElementById('rateLimitBadge');

                multiConnBadge.textContent = `SINGLE_SESSION_PER_USER: ${data.settings.singleSessionPerUser}`;
                multiConnBadge.className = `settings-badge ${data.settings.singleSessionPerUser ? 'off' : 'on'}`;

                rateLimitBadge.textContent = `SHARE_RATE_LIMIT: ${data.settings.shareRateLimit}`;
                rateLimitBadge.className = `settings-badge ${data.settings.shareRateLimit ? 'on' : 'off'}`;

                // 통계
                document.getElementById('totalUsers').textContent = data.stats.totalUsers;
                document.getElementById('totalConnections').textContent = data.stats.totalConnections;
                document.getElementById('localConnections').textContent = users.size;

                // 연결 목록
                const listEl = document.getElementById('connectionList');
                if (data.connections.length === 0) {
                    listEl.innerHTML = '<div class="connection-item" style="color: #999;">연결 없음</div>';
                } else {
                    listEl.innerHTML = data.connections.map(conn => `
                        <div class="connection-item">
                            <span><strong>${conn.name}</strong> (${conn.username})</span>
                            <span style="color: #999;">${conn.connectionId.substring(0, 8)}...</span>
                        </div>
                    `).join('');
                }

            } catch (error) {
                addLog('error', `대시보드 새로고침 실패: ${error.message}`);
            }
        }

        // ===========================================
        // 사용자 관리
        // ===========================================

        async function addUser(username, name) {
            username = username || document.getElementById('newUsername').value || `user_${Date.now()}@test.com`;
            name = name || document.getElementById('newName').value || username.split('@')[0];

            const panelId = `panel_${++panelCounter}`;

            try {
                // JWT 발급
                addLog('info', `JWT 발급 요청...`, name);
                const response = await fetch(`${SERVER_URL}/api/auth/token?username=${encodeURIComponent(username)}&name=${encodeURIComponent(name)}`, {
                    method: 'POST'
                });
                const data = await response.json();

                const userInfo = {
                    panelId,
                    username,
                    name,
                    token: data.access_token,
                    ws: null,
                    connectionId: null
                };

                users.set(panelId, userInfo);
                createUserPanel(userInfo);
                addLog('success', `JWT 발급 성공`, name);

                // 자동 연결
                connectUser(panelId);

            } catch (error) {
                addLog('error', `사용자 추가 실패: ${error.message}`);
            }
        }

        function createUserPanel(userInfo) {
            const container = document.getElementById('userPanels');
            const panel = document.createElement('div');
            panel.id = userInfo.panelId;
            panel.className = 'user-panel disconnected';
            panel.innerHTML = `
                <div class="user-header">
                    <span class="user-name">${userInfo.name} (${userInfo.username})</span>
                    <span class="user-status disconnected" id="${userInfo.panelId}_status">연결 안됨</span>
                </div>
                <div class="user-info" id="${userInfo.panelId}_info">
                    연결 ID: -
                </div>
                <div class="controls">
                    <button class="btn-success" onclick="connectUser('${userInfo.panelId}')" id="${userInfo.panelId}_connectBtn">연결</button>
                    <button class="btn-secondary" onclick="disconnectUser('${userInfo.panelId}')" id="${userInfo.panelId}_disconnectBtn" disabled>연결 해제</button>
                    <button class="btn-primary" onclick="sendQuery('${userInfo.panelId}')" id="${userInfo.panelId}_queryBtn" disabled>요청 전송</button>
                    <button class="btn-warning" onclick="sendMultipleQueries('${userInfo.panelId}', 5)" id="${userInfo.panelId}_query5Btn" disabled>요청 5회</button>
                    <button class="btn-danger" onclick="removeUser('${userInfo.panelId}')">제거</button>
                </div>
                <div class="user-info" id="${userInfo.panelId}_rateLimit" style="margin-top: 10px;">
                    Rate Limit: - / 10
                </div>
            `;
            container.appendChild(panel);
        }

        function updateUserPanel(panelId, connected, connectionId = null, rateLimit = null) {
            const userInfo = users.get(panelId);
            if (!userInfo) return;

            const panel = document.getElementById(panelId);
            const statusEl = document.getElementById(`${panelId}_status`);
            const infoEl = document.getElementById(`${panelId}_info`);
            const connectBtn = document.getElementById(`${panelId}_connectBtn`);
            const disconnectBtn = document.getElementById(`${panelId}_disconnectBtn`);
            const queryBtn = document.getElementById(`${panelId}_queryBtn`);
            const query5Btn = document.getElementById(`${panelId}_query5Btn`);
            const rateLimitEl = document.getElementById(`${panelId}_rateLimit`);

            if (connected) {
                panel.className = 'user-panel connected';
                statusEl.className = 'user-status connected';
                statusEl.textContent = '연결됨';
                infoEl.textContent = `연결 ID: ${connectionId?.substring(0, 8) || '-'}`;
                connectBtn.disabled = true;
                disconnectBtn.disabled = false;
                queryBtn.disabled = false;
                query5Btn.disabled = false;
            } else {
                panel.className = 'user-panel disconnected';
                statusEl.className = 'user-status disconnected';
                statusEl.textContent = '연결 안됨';
                infoEl.textContent = '연결 ID: -';
                connectBtn.disabled = false;
                disconnectBtn.disabled = true;
                queryBtn.disabled = true;
                query5Btn.disabled = true;
            }

            if (rateLimit) {
                const used = rateLimit.limit - rateLimit.remaining;
                rateLimitEl.textContent = `Rate Limit: ${used} / ${rateLimit.limit} (${rateLimit.limitKey} 기준)`;
            }
        }

        // ===========================================
        // WebSocket 연결
        // ===========================================

        function connectUser(panelId) {
            const userInfo = users.get(panelId);
            if (!userInfo || userInfo.ws) return;

            const url = `${WS_URL}?token=${userInfo.token}`;
            const ws = new WebSocket(url);

            ws.onopen = () => {
                addLog('success', 'WebSocket 연결 성공', userInfo.name);
            };

            ws.onmessage = (event) => {
                const data = JSON.parse(event.data);
                handleMessage(panelId, data);
            };

            ws.onerror = (error) => {
                addLog('error', 'WebSocket 에러', userInfo.name);
            };

            ws.onclose = (event) => {
                addLog('info', `연결 종료 (code: ${event.code}, reason: ${event.reason || 'none'})`, userInfo.name);
                userInfo.ws = null;
                userInfo.connectionId = null;
                updateUserPanel(panelId, false);
                refreshDashboard();
            };

            userInfo.ws = ws;
        }

        function disconnectUser(panelId) {
            const userInfo = users.get(panelId);
            if (!userInfo || !userInfo.ws) return;

            userInfo.ws.close();
        }

        function removeUser(panelId) {
            const userInfo = users.get(panelId);
            if (!userInfo) return;

            if (userInfo.ws) {
                userInfo.ws.close();
            }

            users.delete(panelId);
            document.getElementById(panelId)?.remove();
            refreshDashboard();
        }

        // ===========================================
        // 메시지 처리
        // ===========================================

        function handleMessage(panelId, data) {
            const userInfo = users.get(panelId);
            if (!userInfo) return;

            const type = data.type;

            if (type !== 'ping') {
                addLog('receive', `${type}`, userInfo.name);
            }

            switch (type) {
                case 'connected':
                    userInfo.connectionId = data.connectionId;
                    updateUserPanel(panelId, true, data.connectionId, data.rateLimit);
                    addLog('success', `인증 완료 (연결 수: ${data.connectionCount})`, userInfo.name);
                    refreshDashboard();
                    break;

                case 'response':
                    const respConnId = data.connectionId?.substring(0, 8) || '?';
                    // 응답에서 Q번호 추출
                    const qMatch = data.answer?.match(/\[Q(\d+)\]/);
                    const qNum = qMatch ? `Q${qMatch[1]}` : '?';
                    addLog('success', `[conn:${respConnId}] ${qNum} 응답 (remaining: ${data.rateLimit?.remaining})`, userInfo.name);
                    updateUserPanel(panelId, true, userInfo.connectionId, data.rateLimit);
                    break;

                case 'rate_limit_status':
                    updateUserPanel(panelId, true, userInfo.connectionId, data.rateLimit);
                    break;

                case 'error':
                    addLog('error', `[${data.code}] ${data.message}`, userInfo.name);
                    if (data.rateLimit) {
                        updateUserPanel(panelId, true, userInfo.connectionId, data.rateLimit);
                    }
                    break;

                case 'ping':
                    userInfo.ws.send(JSON.stringify({ type: 'pong' }));
                    break;
            }
        }

        function sendQuery(panelId, query = null) {
            const userInfo = users.get(panelId);
            if (!userInfo || !userInfo.ws) return;

            const qid = ++queryCounter;
            const connId = userInfo.connectionId?.substring(0, 8) || '?';
            query = query || `테스트`;

            userInfo.ws.send(JSON.stringify({
                type: 'query',
                query: `[Q${qid}] ${query}`
            }));

            addLog('send', `[conn:${connId}] Q${qid}: ${query}`, userInfo.name);
        }

        async function sendMultipleQueries(panelId, count) {
            for (let i = 0; i < count; i++) {
                sendQuery(panelId, `연속 ${i + 1}/${count}`);
                await new Promise(r => setTimeout(r, 100));
            }
        }

        // ===========================================
        // 동시 요청 테스트
        // ===========================================

        function sendSimultaneousRequests() {
            addLog('info', `=== 동시 요청 테스트 시작 ===`);

            users.forEach((userInfo, panelId) => {
                if (userInfo.ws && userInfo.ws.readyState === WebSocket.OPEN) {
                    sendQuery(panelId, `동시`);
                }
            });
        }

        // ===========================================
        // 초기화
        // ===========================================

        refreshDashboard();
        setInterval(refreshDashboard, 5000);  // 5초마다 자동 새로고침
    </script>
</body>
</html>
