<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebSocket PoC - Integrated</title>
    <style>
        * { box-sizing: border-box; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; }
        body { max-width: 900px; margin: 0 auto; padding: 20px; background: #f5f5f5; }
        h1 { color: #333; margin-bottom: 5px; }
        h3 { margin-top: 0; color: #555; }
        .subtitle { color: #666; margin-top: 0; }

        .section {
            background: white;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            margin-right: 8px;
        }
        .badge.on { background: #e8f5e9; color: #2e7d32; }
        .badge.off { background: #ffebee; color: #c62828; }
        .badge.info { background: #e3f2fd; color: #1565c0; }

        .controls { display: flex; gap: 10px; flex-wrap: wrap; margin: 10px 0; }
        button {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
        }
        button:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn-primary { background: #2196f3; color: white; }
        .btn-success { background: #4caf50; color: white; }
        .btn-danger { background: #f44336; color: white; }
        .btn-warning { background: #ff9800; color: white; }
        .btn-secondary { background: #9e9e9e; color: white; }

        input, select {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 13px;
        }

        .status-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background: #f5f5f5;
            border-radius: 6px;
            margin-bottom: 10px;
        }
        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 8px;
            display: inline-block;
        }
        .status-dot.connected { background: #4caf50; }
        .status-dot.disconnected { background: #9e9e9e; }

        #log {
            height: 250px;
            overflow-y: auto;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 12px;
            line-height: 1.5;
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 15px;
            border-radius: 6px;
        }
        .log-entry { margin-bottom: 2px; }
        .log-time { color: #6a9955; }
        .log-send { color: #569cd6; }
        .log-receive { color: #ce9178; }
        .log-info { color: #dcdcaa; }
        .log-error { color: #f44747; }
        .log-success { color: #4ec9b0; }
    </style>
</head>
<body>
    <h1>WebSocket PoC - Integrated</h1>
    <p class="subtitle">Phase 1-5 검증 완료된 모든 기능 통합 테스트</p>

    <!-- 연결 상태 -->
    <div class="section">
        <div class="status-bar">
            <div>
                <span class="status-dot disconnected" id="statusDot"></span>
                <span id="statusText">연결 안됨</span>
            </div>
            <div>
                <span class="badge info" id="connIdBadge">연결 ID: -</span>
                <span class="badge" id="rateLimitBadge">Rate Limit: - / 10</span>
            </div>
        </div>
        <div class="controls">
            <input type="text" id="username" placeholder="이메일" value="test@example.com" style="width: 180px;">
            <input type="text" id="name" placeholder="이름" value="테스트 사용자" style="width: 120px;">
            <button class="btn-success" onclick="connect()" id="connectBtn">연결</button>
            <button class="btn-danger" onclick="disconnect()" id="disconnectBtn" disabled>연결 해제</button>
        </div>
    </div>

    <!-- 서버 설정 -->
    <div class="section">
        <h3>서버 설정</h3>
        <div>
            <span class="badge" id="sessionBadge">SINGLE_SESSION_PER_USER: -</span>
            <span class="badge" id="shareBadge">SHARE_RATE_LIMIT: -</span>
        </div>
    </div>

    <!-- 요청 테스트 -->
    <div class="section">
        <h3>요청 테스트</h3>
        <div class="controls">
            <input type="text" id="queryInput" placeholder="질문 입력" style="flex: 1;">
            <button class="btn-primary" onclick="sendQuery()" id="queryBtn" disabled>전송</button>
            <button class="btn-warning" onclick="sendMultiple(5)" id="multiBtn" disabled>5회 연속</button>
            <button class="btn-danger" onclick="sendMultiple(12)" id="overBtn" disabled>12회 (초과)</button>
        </div>
    </div>

    <!-- Pong 테스트 -->
    <div class="section">
        <h3>Ping/Pong 테스트</h3>
        <div class="controls">
            <label style="display: flex; align-items: center; gap: 5px;">
                <input type="checkbox" id="pongEnabled" checked>
                Pong 응답 활성화
            </label>
            <span class="badge info" id="pongStatus">Missed: 0/3</span>
        </div>
        <p style="font-size: 12px; color: #666; margin: 5px 0 0 0;">
            체크 해제 시 ping에 응답하지 않아 연결이 끊어집니다 (기본 30초 간격, 3회 무응답 시 종료)
        </p>
    </div>

    <!-- 통신 로그 -->
    <div class="section">
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <h3>통신 로그</h3>
            <button class="btn-secondary" onclick="clearLog()" style="padding: 4px 8px; font-size: 11px;">로그 지우기</button>
        </div>
        <div id="log"></div>
    </div>

    <script>
        const SERVER_URL = 'http://localhost:8000';
        const WS_URL = 'ws://localhost:8000/ws/copilot';

        let ws = null;
        let token = null;
        let connectionId = null;
        let queryCounter = 0;

        const logEl = document.getElementById('log');

        // ===========================================
        // 로그
        // ===========================================

        function addLog(type, message) {
            const time = new Date().toLocaleTimeString('ko-KR');
            const entry = document.createElement('div');
            entry.className = 'log-entry';
            let typeClass = 'log-info';
            let prefix = '';
            if (type === 'send') { typeClass = 'log-send'; prefix = '>>> '; }
            if (type === 'receive') { typeClass = 'log-receive'; prefix = '<<< '; }
            if (type === 'error') { typeClass = 'log-error'; prefix = '!!! '; }
            if (type === 'success') { typeClass = 'log-success'; prefix = 'OK  '; }
            entry.innerHTML = `<span class="log-time">[${time}]</span> <span class="${typeClass}">${prefix}${escapeHtml(message)}</span>`;
            logEl.appendChild(entry);
            logEl.scrollTop = logEl.scrollHeight;
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function clearLog() { logEl.innerHTML = ''; }

        // ===========================================
        // UI 업데이트
        // ===========================================

        function updateUI(connected) {
            document.getElementById('statusDot').className = `status-dot ${connected ? 'connected' : 'disconnected'}`;
            document.getElementById('statusText').textContent = connected ? '연결됨' : '연결 안됨';
            document.getElementById('connectBtn').disabled = connected;
            document.getElementById('disconnectBtn').disabled = !connected;
            document.getElementById('queryBtn').disabled = !connected;
            document.getElementById('multiBtn').disabled = !connected;
            document.getElementById('overBtn').disabled = !connected;

            if (!connected) {
                document.getElementById('connIdBadge').textContent = '연결 ID: -';
            }
        }

        function updateRateLimit(info) {
            if (!info) return;
            const used = info.limit - info.remaining;
            const badge = document.getElementById('rateLimitBadge');
            badge.textContent = `Rate Limit: ${used} / ${info.limit}`;
            badge.className = `badge ${info.remaining > 0 ? 'on' : 'off'}`;
        }

        function updateSettings(settings) {
            if (!settings) return;
            const sessionBadge = document.getElementById('sessionBadge');
            const shareBadge = document.getElementById('shareBadge');

            sessionBadge.textContent = `SINGLE_SESSION_PER_USER: ${settings.singleSessionPerUser}`;
            sessionBadge.className = `badge ${settings.singleSessionPerUser ? 'off' : 'on'}`;

            shareBadge.textContent = `SHARE_RATE_LIMIT: ${settings.shareRateLimit}`;
            shareBadge.className = `badge ${settings.shareRateLimit ? 'on' : 'off'}`;
        }

        // ===========================================
        // 연결
        // ===========================================

        async function connect() {
            const username = document.getElementById('username').value;
            const name = document.getElementById('name').value;

            try {
                // JWT 발급
                addLog('info', 'JWT 토큰 요청...');
                const response = await fetch(`${SERVER_URL}/api/auth/token?username=${encodeURIComponent(username)}&name=${encodeURIComponent(name)}`, {
                    method: 'POST'
                });
                const data = await response.json();
                token = data.access_token;
                addLog('success', 'JWT 발급 완료');

                // WebSocket 연결
                addLog('info', 'WebSocket 연결 시도...');
                ws = new WebSocket(`${WS_URL}?token=${token}`);

                ws.onopen = () => {
                    addLog('success', 'WebSocket 연결 성공');
                };

                ws.onmessage = (event) => {
                    const data = JSON.parse(event.data);
                    handleMessage(data);
                };

                ws.onerror = () => {
                    addLog('error', 'WebSocket 에러');
                };

                ws.onclose = (event) => {
                    addLog('info', `연결 종료 (code: ${event.code}, reason: ${event.reason || 'none'})`);
                    ws = null;
                    connectionId = null;
                    updateUI(false);
                };

            } catch (error) {
                addLog('error', `연결 실패: ${error.message}`);
            }
        }

        function disconnect() {
            if (ws) {
                ws.close();
            }
        }

        // ===========================================
        // 메시지 처리
        // ===========================================

        function handleMessage(data) {
            const type = data.type;

            if (type !== 'ping') {
                addLog('receive', type);
            }

            switch (type) {
                case 'connected':
                    connectionId = data.connectionId;
                    document.getElementById('connIdBadge').textContent = `연결 ID: ${connectionId.substring(0, 8)}`;
                    updateUI(true);
                    updateRateLimit(data.rateLimit);
                    updateSettings(data.settings);
                    addLog('success', `인증 완료 - ${data.user.name} (${data.user.username})`);
                    break;

                case 'response':
                    const qMatch = data.answer?.match(/\[Q(\d+)\]/);
                    const qNum = qMatch ? `Q${qMatch[1]}` : '';
                    addLog('success', `${qNum} 응답 수신 (remaining: ${data.rateLimit?.remaining})`);
                    updateRateLimit(data.rateLimit);
                    break;

                case 'rate_limit_status':
                    updateRateLimit(data.rateLimit);
                    break;

                case 'error':
                    addLog('error', `[${data.code}] ${data.message}`);
                    if (data.rateLimit) {
                        updateRateLimit(data.rateLimit);
                    }
                    break;

                case 'ping':
                    const pongEnabled = document.getElementById('pongEnabled').checked;
                    document.getElementById('pongStatus').textContent = `Missed: ${data.missedPongs}/${data.maxMissedPongs}`;
                    if (pongEnabled) {
                        ws.send(JSON.stringify({ type: 'pong' }));
                    } else {
                        addLog('info', `ping 수신 - pong 응답 비활성화 (missed: ${data.missedPongs})`);
                    }
                    break;
            }
        }

        // ===========================================
        // 요청 전송
        // ===========================================

        function sendQuery() {
            if (!ws) return;

            const input = document.getElementById('queryInput');
            const qid = ++queryCounter;
            const query = input.value || '테스트';

            ws.send(JSON.stringify({
                type: 'query',
                query: `[Q${qid}] ${query}`
            }));

            addLog('send', `Q${qid}: ${query}`);
            input.value = '';
        }

        async function sendMultiple(count) {
            for (let i = 0; i < count; i++) {
                const qid = ++queryCounter;
                ws.send(JSON.stringify({
                    type: 'query',
                    query: `[Q${qid}] 연속 ${i + 1}/${count}`
                }));
                addLog('send', `Q${qid}: 연속 ${i + 1}/${count}`);
                await new Promise(r => setTimeout(r, 100));
            }
        }

        // Enter 키로 전송
        document.getElementById('queryInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && ws) sendQuery();
        });
    </script>
</body>
</html>
