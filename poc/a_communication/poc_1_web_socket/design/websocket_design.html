<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebSocket Design - OpsNow Copilot</title>
    <script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>
    <style>
        :root {
            --primary: #4F46E5;
            --secondary: #10B981;
            --warning: #F59E0B;
            --danger: #EF4444;
            --dark: #1F2937;
            --light: #F9FAFB;
            --white: #FFFFFF;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Pretendard', -apple-system, BlinkMacSystemFont, system-ui, sans-serif;
            line-height: 1.7;
            color: var(--dark);
            background: linear-gradient(135deg, #1e3a5f 0%, #2d5a87 100%);
            min-height: 100vh;
            padding: 40px 20px;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            color: var(--white);
            margin-bottom: 40px;
        }

        header h1 {
            font-size: 2.5rem;
            margin-bottom: 15px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
        }

        header .subtitle {
            font-size: 1.2rem;
            opacity: 0.95;
        }

        header .badge {
            display: inline-block;
            background: rgba(255,255,255,0.2);
            padding: 8px 20px;
            border-radius: 20px;
            margin-top: 15px;
            font-size: 0.9rem;
        }

        .card {
            background: var(--white);
            border-radius: 20px;
            padding: 35px;
            margin-bottom: 25px;
            box-shadow: 0 15px 50px rgba(0,0,0,0.15);
        }

        .card h2 {
            color: var(--primary);
            font-size: 1.4rem;
            margin-bottom: 20px;
            padding-bottom: 12px;
            border-bottom: 3px solid #E0E7FF;
        }

        .card h3 {
            color: var(--dark);
            font-size: 1.1rem;
            margin: 25px 0 15px 0;
        }

        .highlight-box {
            background: linear-gradient(135deg, #EEF2FF 0%, #E0E7FF 100%);
            border-left: 5px solid var(--primary);
            padding: 20px;
            border-radius: 0 15px 15px 0;
            margin: 20px 0;
        }

        .highlight-box.success {
            background: linear-gradient(135deg, #D1FAE5 0%, #A7F3D0 100%);
            border-left-color: var(--secondary);
        }

        .highlight-box.warning {
            background: linear-gradient(135deg, #FEF3C7 0%, #FDE68A 100%);
            border-left-color: var(--warning);
        }

        .highlight-box.danger {
            background: linear-gradient(135deg, #FEE2E2 0%, #FECACA 100%);
            border-left-color: var(--danger);
        }

        .highlight-box h4 {
            color: var(--primary);
            margin-bottom: 8px;
            font-size: 1rem;
        }

        .highlight-box.success h4 { color: #065F46; }
        .highlight-box.warning h4 { color: #92400E; }
        .highlight-box.danger h4 { color: #991B1B; }

        .grid-2 {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            margin: 20px 0;
        }

        .grid-3 {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            margin: 20px 0;
        }

        .grid-4 {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            margin: 20px 0;
        }

        @media (max-width: 768px) {
            .grid-2, .grid-3, .grid-4 {
                grid-template-columns: 1fr;
            }
        }

        .flow-section {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            margin: 20px 0;
        }

        @media (max-width: 900px) {
            .flow-section { grid-template-columns: 1fr; }
        }

        .flow-card {
            background: var(--light);
            border-radius: 12px;
            padding: 20px;
        }

        .flow-card h4 {
            color: var(--dark);
            margin-bottom: 15px;
            font-size: 1rem;
        }

        .flow-card .mermaid {
            background: var(--white);
            border-radius: 8px;
            padding: 15px;
            overflow-x: auto;
        }

        .info-card {
            background: var(--light);
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            border: 2px solid transparent;
            transition: all 0.3s ease;
        }

        .info-card:hover {
            border-color: var(--primary);
            transform: translateY(-3px);
        }

        .info-card .icon {
            font-size: 2rem;
            margin-bottom: 12px;
        }

        .info-card h4 {
            color: var(--dark);
            margin-bottom: 8px;
            font-size: 0.95rem;
        }

        .info-card p {
            font-size: 0.85rem;
            color: #6B7280;
        }

        .badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            margin-top: 8px;
        }

        .badge-green { background: #D1FAE5; color: #065F46; }
        .badge-blue { background: #DBEAFE; color: #1E40AF; }
        .badge-yellow { background: #FEF3C7; color: #92400E; }
        .badge-red { background: #FEE2E2; color: #991B1B; }
        .badge-purple { background: #EDE9FE; color: #5B21B6; }

        .mermaid-container {
            background: var(--white);
            padding: 25px;
            border-radius: 15px;
            margin: 20px 0;
            border: 1px solid #E5E7EB;
            overflow-x: auto;
        }

        .mermaid {
            display: flex;
            justify-content: center;
        }

        .tech-table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
        }

        .tech-table th {
            background: var(--light);
            padding: 12px 15px;
            text-align: left;
            border-bottom: 2px solid #E5E7EB;
            font-size: 0.9rem;
        }

        .tech-table td {
            padding: 12px 15px;
            border-bottom: 1px solid #E5E7EB;
            font-size: 0.9rem;
        }

        .tech-table code {
            background: #E5E7EB;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.85rem;
            font-family: 'Fira Code', monospace;
        }

        .flow-step {
            display: flex;
            align-items: flex-start;
            gap: 20px;
            margin: 15px 0;
            padding: 20px;
            background: var(--light);
            border-radius: 15px;
        }

        .flow-step .number {
            width: 36px;
            height: 36px;
            background: var(--primary);
            color: var(--white);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 1rem;
            flex-shrink: 0;
        }

        .flow-step .content h4 {
            color: var(--dark);
            margin-bottom: 6px;
            font-size: 1rem;
        }

        .flow-step .content p {
            color: #6B7280;
            font-size: 0.9rem;
        }

        .code-block {
            background: #1F2937;
            color: #E5E7EB;
            padding: 20px;
            border-radius: 10px;
            font-family: 'Fira Code', monospace;
            font-size: 0.85rem;
            overflow-x: auto;
            margin: 15px 0;
        }

        .feature-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 15px;
            background: var(--light);
            border-radius: 10px;
            margin: 8px 0;
        }

        .feature-item .check {
            width: 24px;
            height: 24px;
            background: var(--secondary);
            color: var(--white);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 0.8rem;
            flex-shrink: 0;
        }

        .arrow-icon {
            width: 24px;
            height: 24px;
            background: var(--primary);
            color: var(--white);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.9rem;
            flex-shrink: 0;
        }

        .arrow-icon.outgoing { background: #3B82F6; }
        .arrow-icon.incoming { background: #10B981; }

        footer {
            text-align: center;
            color: var(--white);
            padding: 30px 0;
            opacity: 0.8;
            font-size: 0.9rem;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>WebSocket Design</h1>
            <p class="subtitle">OpsNow Copilot - ì‹¤ì‹œê°„ ì–‘ë°©í–¥ í†µì‹  ì„¤ê³„</p>
            <span class="badge">PoC-1: WebSocket í†µì‹ </span>
        </header>

        <!-- ê°œìš” -->
        <div class="card">
            <h2>ì„¤ê³„ ê°œìš”</h2>

            <div class="grid-4">
                <div class="info-card">
                    <div class="icon">ğŸ”Œ</div>
                    <h4>ì‹¤ì‹œê°„ í†µì‹ </h4>
                    <p>ì–‘ë°©í–¥ ë©”ì‹œì§€<br>ì¦‰ì‹œ ì†¡ìˆ˜ì‹ </p>
                    <span class="badge badge-blue">WebSocket</span>
                </div>
                <div class="info-card">
                    <div class="icon">ğŸ”„</div>
                    <h4>ì–‘ë°©í–¥ í†µì‹ </h4>
                    <p>ì„œë²„â†’í´ë¼ì´ì–¸íŠ¸<br>ë°ì´í„° ìš”ì²­ (ì½œë°±)</p>
                    <span class="badge badge-green">Callback</span>
                </div>
                <div class="info-card">
                    <div class="icon">ğŸ”’</div>
                    <h4>ë³´ì•ˆ</h4>
                    <p>One-Time Token<br>ì½œë°± ì‘ë‹µ ê²€ì¦</p>
                    <span class="badge badge-yellow">1íšŒìš©</span>
                </div>
                <div class="info-card">
                    <div class="icon">ğŸ”</div>
                    <h4>ì•ˆì •ì„±</h4>
                    <p>ìë™ ì¬ì—°ê²°<br>ì—ëŸ¬ í•¸ë“¤ë§</p>
                    <span class="badge badge-purple">Reconnect</span>
                </div>
            </div>

            <div class="highlight-box">
                <h4>ê¸°ìˆ  ìŠ¤íƒ</h4>
                <p>
                    <strong>Server:</strong> FastAPI + uvicorn (ASGI)<br>
                    <strong>Client:</strong> ë¸Œë¼ìš°ì € ë„¤ì´í‹°ë¸Œ WebSocket API<br>
                    <strong>Protocol:</strong> RFC 6455 (WebSocket)<br>
                    <strong>Format:</strong> JSON
                </p>
            </div>
        </div>

        <!-- ì—°ê²° ìˆ˜ë¦½ -->
        <div class="card">
            <h2>ì—°ê²° ìˆ˜ë¦½ (Handshake)</h2>

            <h3>ì—”ë“œí¬ì¸íŠ¸</h3>
            <div class="code-block" style="background: #1F2937; color: #E5E7EB; padding: 15px; border-radius: 8px; font-family: monospace;">wss://{host}/ws/copilot?token={auth_token}</div>

            <table class="tech-table" style="margin-top: 15px;">
                <thead>
                    <tr><th>í•­ëª©</th><th>ê°’</th><th>ì„¤ëª…</th></tr>
                </thead>
                <tbody>
                    <tr><td>Protocol</td><td><code>wss://</code></td><td>TLS ì•”í˜¸í™”</td></tr>
                    <tr><td>Path</td><td><code>/ws/copilot</code></td><td>WebSocket ì—”ë“œí¬ì¸íŠ¸</td></tr>
                    <tr><td>Auth</td><td><code>token</code></td><td>Query parameterë¡œ ì¸ì¦ í† í° ì „ë‹¬</td></tr>
                </tbody>
            </table>

            <h3>ì—°ê²° íë¦„</h3>
            <div class="mermaid-container">
                <div class="mermaid">
sequenceDiagram
    participant C as Client
    participant S as Server

    C->>S: GET /ws/copilot?token=xxx
    Note over C,S: Upgrade: websocket

    alt í† í° ìœ íš¨
        S->>C: 101 Switching Protocols
        Note over C,S: WebSocket ì—°ê²° ìˆ˜ë¦½
        S->>C: connected {serverTime}
    else í† í° ë¬´íš¨
        S->>C: 4001 Invalid token
        Note over C: ì—°ê²° ì¢…ë£Œ
    end
                </div>
            </div>

            <h3>ì—°ê²° ì‹¤íŒ¨ ì‹œ</h3>
            <table class="tech-table">
                <thead>
                    <tr><th>HTTP ìƒíƒœ</th><th>ì›ì¸</th><th>í´ë¼ì´ì–¸íŠ¸ ë™ì‘</th></tr>
                </thead>
                <tbody>
                    <tr><td><code>401</code></td><td>í† í° ì—†ìŒ</td><td>ë¡œê·¸ì¸ í˜ì´ì§€ ì´ë™</td></tr>
                    <tr><td><code>403</code></td><td>í† í° ë§Œë£Œ/ë¬´íš¨</td><td>í† í° ê°±ì‹  í›„ ì¬ì‹œë„</td></tr>
                    <tr><td><code>429</code></td><td>Rate Limit ì´ˆê³¼</td><td>ëŒ€ê¸° í›„ ì¬ì‹œë„</td></tr>
                    <tr><td><code>4001</code></td><td>WebSocket í† í° ê²€ì¦ ì‹¤íŒ¨</td><td>ì—°ê²° ì¢…ë£Œ</td></tr>
                </tbody>
            </table>

            <div class="highlight-box warning" style="margin-top: 20px;">
                <h4>Rate Limiting</h4>
                <p>
                    <strong>ìµœëŒ€ ìš”ì²­:</strong> 10 requests / 60ì´ˆ<br>
                    ì´ˆê³¼ ì‹œ <code>429 Too Many Requests</code> ë˜ëŠ” <code>RATE_LIMITED</code> ì—ëŸ¬
                </p>
            </div>
        </div>

        <!-- ì—°ê²° ìˆ˜ëª…ì£¼ê¸° -->
        <div class="card">
            <h2>ì—°ê²° ìˆ˜ëª…ì£¼ê¸°</h2>

            <div class="mermaid-container">
                <div class="mermaid">
stateDiagram-v2
    [*] --> DISCONNECTED
    DISCONNECTED --> CONNECTING: connect()
    CONNECTING --> CONNECTED: connected
    CONNECTED --> RECONNECTING: error/close
    RECONNECTING --> CONNECTING: retry
    RECONNECTING --> DISCONNECTED: max attempts
    CONNECTED --> DISCONNECTED: disconnect()

    note right of CONNECTED: ë©”ì‹œì§€ ì†¡ìˆ˜ì‹  ê°€ëŠ¥
    note right of RECONNECTING: ë©”ì‹œì§€ íì‰
                </div>
            </div>

            <h3>ì—°ê²° ìƒíƒœ</h3>
            <table class="tech-table">
                <thead>
                    <tr>
                        <th>ìƒíƒœ</th>
                        <th>ì„¤ëª…</th>
                        <th>í´ë¼ì´ì–¸íŠ¸ ë™ì‘</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><code>DISCONNECTED</code></td>
                        <td>ì—°ê²° ì—†ìŒ</td>
                        <td>ì—°ê²° ì‹œë„ ê°€ëŠ¥</td>
                    </tr>
                    <tr>
                        <td><code>CONNECTING</code></td>
                        <td>ì—°ê²° ì¤‘</td>
                        <td>ëŒ€ê¸°</td>
                    </tr>
                    <tr>
                        <td><code>CONNECTED</code></td>
                        <td>ì—°ê²°ë¨</td>
                        <td>ë©”ì‹œì§€ ì†¡ìˆ˜ì‹  ê°€ëŠ¥</td>
                    </tr>
                    <tr>
                        <td><code>RECONNECTING</code></td>
                        <td>ì¬ì—°ê²° ì¤‘</td>
                        <td>ë©”ì‹œì§€ íì‰</td>
                    </tr>
                </tbody>
            </table>
        </div>

        <!-- ë©”ì‹œì§€ íƒ€ì… -->
        <div class="card">
            <h2>ë©”ì‹œì§€ íƒ€ì…</h2>

            <div class="grid-2">
                <div>
                    <h3 style="color: #3B82F6;">Client â†’ Server</h3>
                    <div class="feature-item">
                        <span class="arrow-icon outgoing">â†’</span>
                        <span><code>query</code> ì‚¬ìš©ì ì§ˆì˜ + DOM</span>
                    </div>
                    <div class="feature-item">
                        <span class="arrow-icon outgoing">â†’</span>
                        <span><code>human_response</code> ì‚¬ìš©ì ì¶”ê°€ ì…ë ¥</span>
                    </div>
                    <div class="feature-item">
                        <span class="arrow-icon outgoing">â†’</span>
                        <span><code>available_data</code> IndexedDB ë°ì´í„° ëª©ë¡</span>
                    </div>
                    <div class="feature-item">
                        <span class="arrow-icon outgoing">â†’</span>
                        <span><code>api_result</code> IndexedDB ë°ì´í„° ê²°ê³¼</span>
                    </div>
                    <div class="feature-item">
                        <span class="arrow-icon outgoing">â†’</span>
                        <span><code>schema_response</code> IndexedDB ìŠ¤í‚¤ë§ˆ (ëŒ€ìš©ëŸ‰)</span>
                    </div>
                    <div class="feature-item">
                        <span class="arrow-icon outgoing">â†’</span>
                        <span><code>code_result</code> IndexedDB ì½”ë“œ ì‹¤í–‰ ê²°ê³¼ (ëŒ€ìš©ëŸ‰)</span>
                    </div>
                    <div class="feature-item">
                        <span class="arrow-icon outgoing">â†’</span>
                        <span><code>pong</code> í•˜íŠ¸ë¹„íŠ¸ ì‘ë‹µ</span>
                    </div>
                </div>
                <div>
                    <h3 style="color: #10B981;">Server â†’ Client</h3>
                    <div class="feature-item">
                        <span class="arrow-icon incoming">â†</span>
                        <span><code>connected</code> ì—°ê²° í™•ì¸</span>
                    </div>
                    <div class="feature-item">
                        <span class="arrow-icon incoming">â†</span>
                        <span><code>clarification_request</code> ì¶”ê°€ ì§ˆë¬¸</span>
                    </div>
                    <div class="feature-item">
                        <span class="arrow-icon incoming">â†</span>
                        <span><code>request_available_data</code> IndexedDB ëª©ë¡ ìš”ì²­</span>
                    </div>
                    <div class="feature-item">
                        <span class="arrow-icon incoming">â†</span>
                        <span><code>request_api</code> IndexedDB ë°ì´í„° ìš”ì²­</span>
                    </div>
                    <div class="feature-item">
                        <span class="arrow-icon incoming">â†</span>
                        <span><code>request_schema</code> / <code>execute_code</code> ëŒ€ìš©ëŸ‰ ì²˜ë¦¬</span>
                    </div>
                    <div class="feature-item">
                        <span class="arrow-icon incoming">â†</span>
                        <span><code>response</code> ìµœì¢… ì‘ë‹µ</span>
                    </div>
                    <div class="feature-item">
                        <span class="arrow-icon incoming">â†</span>
                        <span><code>error</code> ì—ëŸ¬</span>
                    </div>
                    <div class="feature-item">
                        <span class="arrow-icon incoming">â†</span>
                        <span><code>ping</code> í•˜íŠ¸ë¹„íŠ¸ (30ì´ˆ ì£¼ê¸°)</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- ì „ì²´ ë©”ì‹œì§€ íë¦„ -->
        <div class="card">
            <h2>ì „ì²´ ë©”ì‹œì§€ íë¦„</h2>

            <div class="mermaid-container">
                <div class="mermaid">
sequenceDiagram
    participant C as Client
    participant S as Server
    C->>S: [1] connect
    S->>C: [2] connected {serverTime}

    Note over C: ì‚¬ìš©ì ì§ˆì˜ ì…ë ¥ + DOM
    C->>S: [3] query {query, domContext}

    Note over S: Context Managerì— ì „ë‹¬
    Note over S: RAG ì¡°íšŒ (C ê³„ì¸µ)

    Note over S: ReAct Loop ì²˜ë¦¬
    S->>C: [4] response {answer, suggestions}
                </div>
            </div>
        </div>

        <!-- ì½œë°± íŒ¨í„´ -->
        <div class="card">
            <h2>ì½œë°± íŒ¨í„´: Serverâ†’Clientâ†’Server</h2>

            <p style="color: #6B7280; margin-bottom: 20px;">
                ReAct Loop ì¤‘ <strong>IndexedDB ë°ì´í„°</strong>ê°€ í•„ìš”í•˜ê±°ë‚˜ <strong>ì‚¬ìš©ì í™•ì¸</strong>ì´ í•„ìš”í•œ ê²½ìš° ì‚¬ìš©í•˜ëŠ” ë¹„ë™ê¸° íŒ¨í„´
            </p>

            <div class="highlight-box">
                <h4>ê¸°ë³¸ íë¦„ vs ì½œë°± íë¦„</h4>
                <p>
                    <strong>ê¸°ë³¸:</strong> queryì— DOMë§Œ í¬í•¨, ì„œë²„ê°€ í•„ìš” ì‹œ request_available_data â†’ available_dataë¡œ ëª©ë¡ ì¡°íšŒ<br>
                    <strong>ì½œë°±:</strong> ReAct Loop ì¤‘ IndexedDB ë°ì´í„° ì¡°íšŒ/ì‚¬ìš©ì í™•ì¸ í•„ìš” ì‹œ ì½œë°± ë°œìƒ
                </p>
            </div>

            <div class="flow-section">
                <div class="flow-card">
                    <h4>ask_human ì½œë°± íë¦„</h4>
                    <div class="mermaid">
sequenceDiagram
    participant C as Client
    participant S as Server

    S->>C: clarification_request {question, options}
    Note over S: ask_human í˜¸ì¶œ
    Note over C: [ì‚¬ìš©ì ì…ë ¥ ëŒ€ê¸°]
    C->>S: human_response {response}
                    </div>
                </div>

                <div class="flow-card">
                    <h4>request_api ì½œë°± íë¦„ (IndexedDB)</h4>
                    <div class="mermaid">
sequenceDiagram
    participant C as Client
    participant S as Server

    S->>C: request_available_data
    C->>S: available_data {data: [...]}
    Note over S: í•„ìš” ë°ì´í„° ì„ íƒ
    S->>C: request_api {dataKey}
    Note over C: [IndexedDB ì¡°íšŒ]
    C->>S: api_result {success, data}
                    </div>
                </div>
            </div>

            <h3>í™œìš©ì²˜ (ReAct Loop ë„êµ¬)</h3>
            <div class="grid-3">
                <div class="info-card">
                    <div class="icon">ğŸ’¬</div>
                    <h4>ask_human</h4>
                    <p>ì‚¬ìš©ì í™•ì¸/ë˜ë¬¼ìŒ<br>(ìœ„í—˜ë„ ê¸°ë°˜)</p>
                    <span class="badge badge-yellow">2ë¶„ íƒ€ì„ì•„ì›ƒ</span>
                </div>
                <div class="info-card">
                    <div class="icon">ğŸ”—</div>
                    <h4>request_api</h4>
                    <p>IndexedDB ë°ì´í„° ì¡°íšŒ<br>(dataKeyë¡œ ì§€ì •)</p>
                    <span class="badge badge-green">60ì´ˆ íƒ€ì„ì•„ì›ƒ</span>
                </div>
                <div class="info-card">
                    <div class="icon">ğŸ“Š</div>
                    <h4>ëŒ€ìš©ëŸ‰ ì²˜ë¦¬</h4>
                    <p>request_schema + execute_code<br>(ProgramOfThought)</p>
                    <span class="badge badge-blue">10ì´ˆ íƒ€ì„ì•„ì›ƒ</span>
                </div>
            </div>

            <div class="highlight-box success">
                <h4>asyncio.Future ê¸°ë°˜ êµ¬í˜„</h4>
                <p>
                    ì„œë²„ëŠ” <code>asyncio.Future</code>ë¥¼ ìƒì„±í•˜ê³  <code>await</code>ë¡œ ëŒ€ê¸°í•©ë‹ˆë‹¤.<br>
                    í´ë¼ì´ì–¸íŠ¸ê°€ IndexedDBì—ì„œ ì¡°íšŒí•œ ê²°ê³¼ê°€ ë„ì°©í•˜ë©´ <code>future.set_result()</code>ë¡œ ëŒ€ê¸°ë¥¼ í•´ì œí•©ë‹ˆë‹¤.
                </p>
            </div>
        </div>

        <!-- One-Time Token -->
        <div class="card">
            <h2>One-Time Token ë³´ì•ˆ</h2>

            <div class="flow-step">
                <div class="number">1</div>
                <div class="content">
                    <h4>í† í° ë°œê¸‰</h4>
                    <p>ì„œë²„ê°€ ìš”ì²­ ì‹œ ì¼íšŒìš© í† í° ìƒì„± ë° ì „ì†¡ (timestamp + random)</p>
                </div>
            </div>
            <div class="flow-step">
                <div class="number">2</div>
                <div class="content">
                    <h4>ì‘ë‹µ ì²¨ë¶€</h4>
                    <p>í´ë¼ì´ì–¸íŠ¸ê°€ ì‘ë‹µ ì‹œ ë°›ì€ í† í°ì„ requestIdë¡œ ì²¨ë¶€</p>
                </div>
            </div>
            <div class="flow-step">
                <div class="number">3</div>
                <div class="content">
                    <h4>ê²€ì¦ ë° íê¸°</h4>
                    <p>ì„œë²„ê°€ í† í° ê²€ì¦ í›„ ì¦‰ì‹œ íê¸° (1íšŒìš©)</p>
                </div>
            </div>

            <h3>ë³´ì•ˆ íš¨ê³¼</h3>
            <table class="tech-table">
                <thead>
                    <tr>
                        <th>ê³µê²© ìœ í˜•</th>
                        <th>ë°©ì–´</th>
                        <th>ì„¤ëª…</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>Replay Attack</td>
                        <td><span class="badge badge-green">ì™„ì „ ì°¨ë‹¨</span></td>
                        <td>ì‚¬ìš© ì¦‰ì‹œ íê¸° (1íšŒìš©)</td>
                    </tr>
                    <tr>
                        <td>í† í° íƒˆì·¨ í›„ ì‚¬ìš©</td>
                        <td><span class="badge badge-green">ë¬´ì˜ë¯¸</span></td>
                        <td>ì´ë¯¸ íê¸°ë¨</td>
                    </tr>
                    <tr>
                        <td>ìœ„ì¡° ì‘ë‹µ ì£¼ì…</td>
                        <td><span class="badge badge-green">ê±°ë¶€</span></td>
                        <td>í† í° ì—†ìœ¼ë©´ ë¬´ì‹œ</td>
                    </tr>
                    <tr>
                        <td>ì˜¤ë˜ëœ í† í°</td>
                        <td><span class="badge badge-green">ë§Œë£Œ</span></td>
                        <td>íƒ€ì„ìŠ¤íƒ¬í”„ ê²€ì¦</td>
                    </tr>
                </tbody>
            </table>

            <div class="code-block">
// í† í° êµ¬ì¡°<br>
{timestamp}-{random}<br><br>
// ì˜ˆì‹œ<br>
1705123456789-abc123def456ghi789<br>
â”‚              â”‚<br>
â”‚              â””â”€â”€ ëœë¤ ë¬¸ìì—´ (URL-safe, 16+ chars)<br>
â””â”€â”€ Unix timestamp (ms)
            </div>
        </div>

        <!-- ì—ëŸ¬ í•¸ë“¤ë§ -->
        <div class="card">
            <h2>ì—ëŸ¬ í•¸ë“¤ë§</h2>

            <h3>ì—ëŸ¬ ì½”ë“œ</h3>
            <table class="tech-table">
                <thead>
                    <tr>
                        <th>ì½”ë“œ</th>
                        <th>ì„¤ëª…</th>
                        <th>ì¬ì‹œë„</th>
                        <th>í´ë¼ì´ì–¸íŠ¸ ì•¡ì…˜</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><code>CONNECTION_CLOSED</code></td>
                        <td>ì—°ê²° ì¢…ë£Œ</td>
                        <td><span class="badge badge-green">Yes</span></td>
                        <td>ì¬ì—°ê²° ì‹œë„</td>
                    </tr>
                    <tr>
                        <td><code>INVALID_MESSAGE</code></td>
                        <td>ì˜ëª»ëœ ë©”ì‹œì§€ í˜•ì‹</td>
                        <td><span class="badge badge-red">No</span></td>
                        <td>ë©”ì‹œì§€ ìˆ˜ì •</td>
                    </tr>
                    <tr>
                        <td><code>INVALID_TOKEN</code></td>
                        <td>ìœ íš¨í•˜ì§€ ì•Šì€ í† í°</td>
                        <td><span class="badge badge-red">No</span></td>
                        <td>ë¬´ì‹œ</td>
                    </tr>
                    <tr>
                        <td><code>TIMEOUT</code></td>
                        <td>ì‘ë‹µ ì‹œê°„ ì´ˆê³¼</td>
                        <td><span class="badge badge-green">Yes</span></td>
                        <td>ì¬ì‹œë„ ë˜ëŠ” ì·¨ì†Œ</td>
                    </tr>
                    <tr>
                        <td><code>RATE_LIMITED</code></td>
                        <td>ìš”ì²­ ì œí•œ ì´ˆê³¼</td>
                        <td><span class="badge badge-green">Yes</span></td>
                        <td>ëŒ€ê¸° í›„ ì¬ì‹œë„</td>
                    </tr>
                    <tr>
                        <td><code>INTERNAL_ERROR</code></td>
                        <td>ì„œë²„ ë‚´ë¶€ ì—ëŸ¬</td>
                        <td><span class="badge badge-green">Yes</span></td>
                        <td>ì¬ì‹œë„</td>
                    </tr>
                </tbody>
            </table>

            <h3>ì¬ì—°ê²° ì „ëµ (Exponential Backoff)</h3>
            <div class="grid-4">
                <div class="info-card">
                    <h4>1íšŒì°¨</h4>
                    <p><strong>1ì´ˆ</strong> í›„</p>
                </div>
                <div class="info-card">
                    <h4>2íšŒì°¨</h4>
                    <p><strong>2ì´ˆ</strong> í›„</p>
                </div>
                <div class="info-card">
                    <h4>3íšŒì°¨</h4>
                    <p><strong>4ì´ˆ</strong> í›„</p>
                </div>
                <div class="info-card">
                    <h4>NíšŒì°¨</h4>
                    <p><strong>ìµœëŒ€ 30ì´ˆ</strong></p>
                </div>
            </div>

            <div class="highlight-box warning">
                <h4>Jitter ì ìš©</h4>
                <p>ë™ì‹œ ì¬ì—°ê²° ë°©ì§€ë¥¼ ìœ„í•´ Â±30% ëœë¤ ì§€ì—° ì¶”ê°€</p>
            </div>
        </div>

        <!-- ì„±ëŠ¥ ê³ ë ¤ì‚¬í•­ -->
        <div class="card">
            <h2>ì„±ëŠ¥ ê³ ë ¤ì‚¬í•­</h2>

            <h3>ë©”ì‹œì§€ í¬ê¸° ì œí•œ</h3>
            <table class="tech-table">
                <thead>
                    <tr>
                        <th>ë©”ì‹œì§€</th>
                        <th>ê¶Œì¥ ìµœëŒ€</th>
                        <th>ë¹„ê³ </th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><code>query</code></td>
                        <td>50KB</td>
                        <td>domContext (~2000 í† í°) í¬í•¨</td>
                    </tr>
                    <tr>
                        <td><code>api_result</code></td>
                        <td>100KB</td>
                        <td>ì´ˆê³¼ ì‹œ isLargeData: true</td>
                    </tr>
                    <tr>
                        <td><code>schema_response</code></td>
                        <td>2KB</td>
                        <td>ìŠ¤í‚¤ë§ˆë§Œ</td>
                    </tr>
                    <tr>
                        <td><code>code_result</code></td>
                        <td>1KB</td>
                        <td>ì¶”ì¶œ ê²°ê³¼ë§Œ</td>
                    </tr>
                    <tr>
                        <td><code>response</code></td>
                        <td>50KB</td>
                        <td>answer + suggestions</td>
                    </tr>
                </tbody>
            </table>

            <div class="highlight-box">
                <h4>í•˜íŠ¸ë¹„íŠ¸ (Keep-Alive)</h4>
                <p>
                    <strong>ì£¼ê¸°:</strong> 30ì´ˆ<br>
                    <strong>ë©”ì‹œì§€:</strong> ping/pong<br>
                    <strong>ëª©ì :</strong> ì—°ê²° ìœ ì§€, ëŠê¹€ ê°ì§€
                </p>
            </div>
        </div>

        <!-- í•µì‹¬ ì •ë¦¬ -->
        <div class="card">
            <h2>í•µì‹¬ ì •ë¦¬</h2>

            <div class="feature-item">
                <span class="check">1</span>
                <span><strong>WebSocket ì–‘ë°©í–¥ í†µì‹ </strong> - RFC 6455, JSON ë©”ì‹œì§€, ì‹¤ì‹œê°„ ì†¡ìˆ˜ì‹ </span>
            </div>
            <div class="feature-item">
                <span class="check">2</span>
                <span><strong>Serverâ†’Clientâ†’Server ì½œë°±</strong> - asyncio.Future ê¸°ë°˜, ì„œë²„ê°€ í´ë¼ì´ì–¸íŠ¸ ë°ì´í„° ìš”ì²­</span>
            </div>
            <div class="feature-item">
                <span class="check">3</span>
                <span><strong>One-Time Token ë³´ì•ˆ</strong> - Replay Attack ë°©ì§€, ì‚¬ìš© ì¦‰ì‹œ íê¸°</span>
            </div>
            <div class="feature-item">
                <span class="check">4</span>
                <span><strong>ìë™ ì¬ì—°ê²°</strong> - Exponential Backoff with Jitter, ë©”ì‹œì§€ íì‰</span>
            </div>
            <div class="feature-item">
                <span class="check">5</span>
                <span><strong>ì—ëŸ¬ ì½”ë“œ ì²´ê³„</strong> - retryable ì—¬ë¶€ êµ¬ë¶„, í´ë¼ì´ì–¸íŠ¸ ì•¡ì…˜ ê°€ì´ë“œ</span>
            </div>
        </div>

        <footer>
            <p>OpsNow Copilot - WebSocket Design Document</p>
            <p>PoC-1: WebSocket í†µì‹ </p>
        </footer>
    </div>

    <script>
        mermaid.initialize({
            startOnLoad: true,
            theme: 'default',
            securityLevel: 'loose',
            flowchart: {
                useMaxWidth: true,
                htmlLabels: true,
                curve: 'basis'
            },
            sequence: {
                useMaxWidth: true,
                showSequenceNumbers: false
            },
            stateDiagram: {
                useMaxWidth: true
            }
        });
    </script>
</body>
</html>
