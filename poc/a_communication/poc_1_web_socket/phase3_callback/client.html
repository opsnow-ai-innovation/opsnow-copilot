<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebSocket PoC - Phase 3 (ì½œë°± íŒ¨í„´)</title>
    <style>
        * {
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }
        body {
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        h1 { color: #333; }
        h3 { margin-top: 0; color: #555; }

        .section {
            background: white;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .status {
            padding: 10px 15px;
            border-radius: 8px;
            font-weight: bold;
            display: inline-block;
        }
        .status.disconnected { background: #ffebee; color: #c62828; }
        .status.connecting { background: #fff3e0; color: #ef6c00; }
        .status.connected { background: #e8f5e9; color: #2e7d32; }

        .controls {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin: 10px 0;
        }
        button {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
        }
        button:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn-primary { background: #2196f3; color: white; }
        .btn-success { background: #4caf50; color: white; }
        .btn-danger { background: #f44336; color: white; }
        .btn-warning { background: #ff9800; color: white; }
        .btn-secondary { background: #9e9e9e; color: white; }

        .input-group {
            display: flex;
            gap: 10px;
            margin: 10px 0;
        }
        input[type="text"] {
            flex: 1;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
        }

        #log {
            height: 300px;
            overflow-y: auto;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 12px;
            line-height: 1.5;
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 15px;
            border-radius: 6px;
        }
        .log-entry { margin-bottom: 4px; padding: 2px 0; border-bottom: 1px solid #333; }
        .log-time { color: #6a9955; }
        .log-send { color: #569cd6; }
        .log-receive { color: #ce9178; }
        .log-info { color: #dcdcaa; }
        .log-error { color: #f44747; }
        .log-success { color: #4ec9b0; }
        .log-callback { color: #c586c0; }

        .callback-flow {
            background: #263238;
            color: #aed581;
            padding: 15px;
            border-radius: 6px;
            font-family: monospace;
            font-size: 12px;
            white-space: pre-line;
        }

        .indexed-db {
            background: #e8f5e9;
            padding: 15px;
            border-radius: 6px;
            margin: 10px 0;
        }
        .indexed-db h4 { margin: 0 0 10px 0; color: #2e7d32; }
        .indexed-db-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px;
            background: white;
            border-radius: 4px;
            margin: 5px 0;
        }
        .indexed-db-item.disabled {
            background: #ffebee;
            opacity: 0.6;
        }
        .indexed-db-item input[type="checkbox"] {
            width: 18px;
            height: 18px;
            margin-right: 10px;
        }

        /* í…ŒìŠ¤íŠ¸ ì œì–´íŒ */
        .test-panel {
            background: #fff3e0;
            border: 2px solid #ff9800;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
        }
        .test-panel h4 { margin: 0 0 15px 0; color: #e65100; }
        .test-scenario {
            background: white;
            padding: 15px;
            border-radius: 6px;
            margin: 10px 0;
            border-left: 4px solid #2196f3;
        }
        .test-scenario.scenario-2 { border-left-color: #9c27b0; }
        .test-scenario.scenario-3 { border-left-color: #f44336; }
        .test-scenario h5 { margin: 0 0 8px 0; }
        .test-scenario p { margin: 0 0 10px 0; color: #666; font-size: 13px; }
        .test-controls {
            display: flex;
            align-items: center;
            gap: 15px;
            flex-wrap: wrap;
            margin: 10px 0;
        }
        .test-controls label {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 13px;
        }
        .test-controls select, .test-controls input[type="number"] {
            padding: 5px 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .toggle-switch {
            position: relative;
            width: 50px;
            height: 26px;
        }
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0; left: 0; right: 0; bottom: 0;
            background-color: #ccc;
            transition: 0.3s;
            border-radius: 26px;
        }
        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 20px;
            width: 20px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: 0.3s;
            border-radius: 50%;
        }
        .toggle-switch input:checked + .toggle-slider {
            background-color: #4caf50;
        }
        .toggle-switch input:checked + .toggle-slider:before {
            transform: translateX(24px);
        }

        /* ì‚¬ìš©ì ì…ë ¥ ëª¨ë‹¬ */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .modal.show { display: flex; }
        .modal-content {
            background: white;
            padding: 25px;
            border-radius: 12px;
            max-width: 400px;
            width: 90%;
        }
        .modal-content h3 { margin-top: 0; }
        .modal-options {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin: 15px 0;
        }
        .modal-option {
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .modal-option:hover { border-color: #2196f3; background: #e3f2fd; }
        .modal-option.selected { border-color: #2196f3; background: #e3f2fd; }
    </style>
</head>
<body>
    <h1>WebSocket PoC - Phase 3: ì½œë°± íŒ¨í„´</h1>
    <p style="color: #666; margin-top: -10px;">ì„œë²„ê°€ í´ë¼ì´ì–¸íŠ¸ì— ë°ì´í„°ë¥¼ ìš”ì²­í•˜ê³  ì‘ë‹µì„ ê¸°ë‹¤ë¦¬ëŠ” íŒ¨í„´ ê²€ì¦ (Server â†’ Client ìš”ì²­ í›„ Client â†’ Server ì‘ë‹µ)</p>

    <!-- ì—°ê²° ìƒíƒœ -->
    <div class="section">
        <h3>ì—°ê²° ìƒíƒœ</h3>
        <div id="status" class="status disconnected">ì—°ê²° ì•ˆë¨</div>
        <div class="controls" style="margin-top: 10px;">
            <button class="btn-success" onclick="connectWithToken()">JWT ë°œê¸‰ & ì—°ê²°</button>
            <button id="disconnectBtn" class="btn-secondary" onclick="disconnect()" disabled>ì—°ê²° í•´ì œ</button>
        </div>
    </div>

    <!-- 3-1. One-Time Token í…ŒìŠ¤íŠ¸ -->
    <div class="section">
        <h3>3-1. One-Time Token í…ŒìŠ¤íŠ¸</h3>
        <p style="color: #666; font-size: 13px; margin-top: -5px;">ì„œë²„ê°€ ë°œê¸‰í•œ requestIdì˜ ë°œê¸‰/ë§¤ì¹­ ê²€ì¦</p>
        <div class="test-panel" style="background: #fff3e0; border-color: #ff9800;">
            <div class="test-controls" style="flex-wrap: wrap; gap: 10px;">
                <button class="btn-primary" onclick="runTokenTest('normal')" id="tokenTestNormalBtn" disabled>ì •ìƒ ë§¤ì¹­</button>
                <button class="btn-danger" onclick="runTokenTest('invalid')" id="tokenTestInvalidBtn" disabled>ì˜ëª»ëœ í† í°</button>
                <button class="btn-danger" onclick="runTokenTest('duplicate')" id="tokenTestDuplicateBtn" disabled>ì¤‘ë³µ ì‚¬ìš©</button>
            </div>
            <div style="margin-top: 15px; padding: 10px; background: #fffde7; border-radius: 4px; font-size: 12px;">
                <strong>í…ŒìŠ¤íŠ¸ ë°©ë²•:</strong>
                <ul style="margin: 5px 0 0 20px; padding: 0;">
                    <li><b>ì •ìƒ ë§¤ì¹­</b>: ì„œë²„ê°€ ë°œê¸‰í•œ requestIdë¡œ ì‘ë‹µ â†’ ì„±ê³µ</li>
                    <li><b>ì˜ëª»ëœ í† í°</b>: ì¡´ì¬í•˜ì§€ ì•ŠëŠ” requestIdë¡œ ì‘ë‹µ â†’ ì‹¤íŒ¨</li>
                    <li><b>ì¤‘ë³µ ì‚¬ìš©</b>: ê°™ì€ requestIdë¡œ ë‘ ë²ˆ ì‘ë‹µ â†’ ë‘ ë²ˆì§¸ ì‹¤íŒ¨</li>
                </ul>
            </div>
        </div>
    </div>

    <!-- 3-2. ì½œë°± íŒ¨í„´ ì‹œë‚˜ë¦¬ì˜¤ -->
    <div class="section">
        <h3>3-2. ì½œë°± íŒ¨í„´ ì‹œë‚˜ë¦¬ì˜¤</h3>
        <p style="color: #666; font-size: 13px; margin-top: -5px;">ì½œë°± íë¦„ë³„ ë™ì‘ ê²€ì¦</p>
        <div class="test-panel">
            <!-- ì‹œë‚˜ë¦¬ì˜¤ 1: ê¸°ë³¸ ì½œë°± íë¦„ -->
            <div class="test-scenario">
                <h5>ì‹œë‚˜ë¦¬ì˜¤ 1: ê¸°ë³¸ ì½œë°± íë¦„</h5>
                <p style="font-size: 12px; line-height: 1.6;">
                    query<span style="color: #1976d2;">(Câ†’S)</span> â†’
                    request_available_data<span style="color: #d32f2f;">(Sâ†’C)</span> â†’
                    available_data<span style="color: #1976d2;">(Câ†’S)</span> â†’
                    request_api<span style="color: #d32f2f;">(Sâ†’C)</span> â†’
                    api_result<span style="color: #1976d2;">(Câ†’S)</span> â†’
                    response<span style="color: #d32f2f;">(Sâ†’C)</span>
                </p>
                <div class="test-controls">
                    <label title="ì„œë²„ ìš”ì²­ì— ì‘ë‹µí•˜ê¸°ê¹Œì§€ ê±¸ë¦¬ëŠ” ì‹œê°„">
                        ì‘ë‹µ ì§€ì—°:
                        <input type="number" id="responseDelay" value="300" min="0" max="5000" step="100" style="width: 80px;"> ms
                    </label>
                    <label class="toggle-switch" title="OFF ì‹œ ì„œë²„ ìš”ì²­ì— ì‘ë‹µí•˜ì§€ ì•ŠìŒ (íƒ€ì„ì•„ì›ƒ ë°œìƒ)">
                        <input type="checkbox" id="autoResponseEnabled" checked>
                        <span class="toggle-slider"></span>
                    </label>
                    <span style="font-size: 13px;">ìë™ ì‘ë‹µ <span style="color: #999; font-size: 11px;">(OFF: ì„œë²„ ìš”ì²­ ë¬´ì‹œ)</span></span>
                </div>
                <button class="btn-primary" onclick="runScenario1()" id="scenario1Btn" disabled>ì‹œë‚˜ë¦¬ì˜¤ 1 ì‹¤í–‰</button>
            </div>

            <!-- ì‹œë‚˜ë¦¬ì˜¤ 2: Clarification í…ŒìŠ¤íŠ¸ -->
            <div class="test-scenario scenario-2">
                <h5>ì‹œë‚˜ë¦¬ì˜¤ 2: Clarification (ì‚¬ìš©ì ì…ë ¥ ìš”ì²­)</h5>
                <p style="font-size: 12px; line-height: 1.6;">
                    query<span style="color: #1976d2;">(Câ†’S)</span> â†’
                    clarification_request<span style="color: #d32f2f;">(Sâ†’C)</span> â†’
                    ì‚¬ìš©ì ì„ íƒ â†’
                    human_response<span style="color: #1976d2;">(Câ†’S)</span> â†’
                    response<span style="color: #d32f2f;">(Sâ†’C)</span>
                </p>
                <button class="btn-warning" onclick="runScenario2()" id="scenario2Btn" disabled>ì‹œë‚˜ë¦¬ì˜¤ 2 ì‹¤í–‰</button>
            </div>

            <!-- ì‹œë‚˜ë¦¬ì˜¤ 3: íƒ€ì„ì•„ì›ƒ í…ŒìŠ¤íŠ¸ -->
            <div class="test-scenario scenario-3">
                <h5>ì‹œë‚˜ë¦¬ì˜¤ 3: íƒ€ì„ì•„ì›ƒ í…ŒìŠ¤íŠ¸</h5>
                <p>ì‘ë‹µ ì§€ì—°ìœ¼ë¡œ ì„œë²„ íƒ€ì„ì•„ì›ƒ ë°œìƒ í™•ì¸ (ì„œë²„ íƒ€ì„ì•„ì›ƒ: 10ì´ˆ)</p>
                <button class="btn-danger" onclick="runScenario3()" id="scenario3Btn" disabled>ì‹œë‚˜ë¦¬ì˜¤ 3 ì‹¤í–‰ (15ì´ˆ ì§€ì—°)</button>
                <button class="btn-secondary" onclick="restoreAndReset()" style="margin-left: 10px;">ì„¤ì • ë³µêµ¬</button>
            </div>

            <!-- ì‹œë‚˜ë¦¬ì˜¤ 4: ê¸°íƒ€ ì—ëŸ¬ ì¼€ì´ìŠ¤ -->
            <div class="test-scenario" style="border-left-color: #607d8b;">
                <h5>ì‹œë‚˜ë¦¬ì˜¤ 4: ê¸°íƒ€ ì—ëŸ¬ ì¼€ì´ìŠ¤</h5>
                <div class="test-controls" style="flex-direction: column; align-items: flex-start; gap: 10px;">
                    <div>
                        <button class="btn-secondary" onclick="runScenario4a()" id="scenario4aBtn" disabled>4-A: ì‘ë‹µ ì—†ìŒ</button>
                        <span style="font-size: 12px; color: #666; margin-left: 8px;">í´ë¼ì´ì–¸íŠ¸ ë©ˆì¶¤/ì˜¤ë¥˜ ìƒí™©</span>
                    </div>
                    <div>
                        <button class="btn-secondary" onclick="runScenario4b()" id="scenario4bBtn" disabled>4-B: ë¹ˆ ë°ì´í„°</button>
                        <span style="font-size: 12px; color: #666; margin-left: 8px;">ìºì‹œ ì—†ìŒ/ì²« ë°©ë¬¸ ìƒí™©</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Mock IndexedDB -->
    <div class="section">
        <h3>Mock IndexedDB (í´ë¼ì´ì–¸íŠ¸ ì €ì¥ì†Œ)</h3>
        <div class="indexed-db">
            <h4>ì €ì¥ëœ ë°ì´í„° ëª©ë¡</h4>
            <div class="test-controls" style="margin-bottom: 10px;">
                <button class="btn-secondary" onclick="toggleAllData(true)" style="padding: 5px 10px; font-size: 12px;">ì „ì²´ í™œì„±í™”</button>
                <button class="btn-secondary" onclick="toggleAllData(false)" style="padding: 5px 10px; font-size: 12px;">ì „ì²´ ë¹„í™œì„±í™”</button>
            </div>
            <div id="indexedDbList"></div>
        </div>
    </div>

    <!-- ì½œë°± íë¦„ -->
    <div class="section">
        <h3>ì½œë°± íë¦„ ì‹œê°í™”</h3>
        <div class="callback-flow" id="callbackFlow">
ì½œë°± íë¦„ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤...

ì˜ˆìƒ íë¦„:
1. Client â†’ Server: query
2. Server â†’ Client: request_available_data (requestId í¬í•¨)
3. Client â†’ Server: available_data (requestId í¬í•¨)
4. Server â†’ Client: request_api (dataKey, requestId í¬í•¨)
5. Client â†’ Server: api_result (requestId í¬í•¨)
6. Server â†’ Client: response
        </div>
    </div>

    <!-- í†µì‹  ë¡œê·¸ -->
    <div class="section">
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <h3>í†µì‹  ë¡œê·¸</h3>
            <button class="btn-secondary" onclick="clearLog()" style="padding: 5px 10px; font-size: 12px;">ë¡œê·¸ ì§€ìš°ê¸°</button>
        </div>
        <div id="log"></div>
    </div>

    <!-- ì‚¬ìš©ì ì…ë ¥ ëª¨ë‹¬ (clarification_requestìš©) -->
    <div class="modal" id="clarificationModal">
        <div class="modal-content">
            <h3 id="modalQuestion">ì§ˆë¬¸</h3>
            <div class="modal-options" id="modalOptions"></div>
            <div class="input-group" id="modalTextInput" style="display: none;">
                <input type="text" id="modalTextValue" placeholder="ë‹µë³€ì„ ì…ë ¥í•˜ì„¸ìš”...">
            </div>
            <div class="controls">
                <button class="btn-primary" onclick="submitClarification()">ì‘ë‹µ</button>
                <button class="btn-secondary" onclick="cancelClarification()">ì·¨ì†Œ</button>
            </div>
        </div>
    </div>

    <script>
        const SERVER_URL = 'http://localhost:8000';
        const WS_URL = 'ws://localhost:8000/ws/copilot';

        let ws = null;
        let currentToken = null;
        let pendingClarification = null;  // { requestId, resolve, reject }
        let callbackSteps = [];

        // Mock IndexedDB ë°ì´í„°
        const mockIndexedDB = {
            "costSummary": {
                description: "ì›”ë³„ ë¹„ìš© ìš”ì•½",
                size: 1024,
                enabled: true,
                data: {
                    totalCost: "$45,678",
                    change: "+15%",
                    period: "2024-01",
                    topServices: ["EC2", "Lambda", "S3"]
                }
            },
            "costTrend": {
                description: "ë¹„ìš© ì¶”ì„¸ ë°ì´í„°",
                size: 52000,
                enabled: true,
                data: {
                    months: ["2024-01", "2024-02", "2024-03"],
                    values: [42000, 45000, 45678]
                }
            },
            "resourceList": {
                description: "ë¦¬ì†ŒìŠ¤ ëª©ë¡",
                size: 2048000,
                enabled: true,
                data: {
                    totalResources: 1523,
                    byType: { EC2: 45, Lambda: 120, S3: 30 }
                }
            }
        };

        // í…ŒìŠ¤íŠ¸ ì„¤ì •
        let testConfig = {
            autoResponseEnabled: true,
            responseDelay: 300,
            savedResponseDelay: 300,
            savedAutoResponse: true
        };

        // UI ìš”ì†Œ
        const statusEl = document.getElementById('status');
        const logEl = document.getElementById('log');
        const disconnectBtn = document.getElementById('disconnectBtn');
        const callbackFlowEl = document.getElementById('callbackFlow');
        const scenario1Btn = document.getElementById('scenario1Btn');
        const scenario2Btn = document.getElementById('scenario2Btn');
        const scenario3Btn = document.getElementById('scenario3Btn');
        const scenario4aBtn = document.getElementById('scenario4aBtn');
        const scenario4bBtn = document.getElementById('scenario4bBtn');
        const tokenTestNormalBtn = document.getElementById('tokenTestNormalBtn');
        const tokenTestInvalidBtn = document.getElementById('tokenTestInvalidBtn');
        const tokenTestDuplicateBtn = document.getElementById('tokenTestDuplicateBtn');
        const autoResponseCheckbox = document.getElementById('autoResponseEnabled');
        const responseDelayInput = document.getElementById('responseDelay');

        // One-Time Token í…ŒìŠ¤íŠ¸ ì„¤ì •
        let tokenTestMode = 'normal';  // 'normal', 'invalid', 'duplicate'
        let lastUsedRequestId = null;  // ì¤‘ë³µ í…ŒìŠ¤íŠ¸ìš©

        // ì´ˆê¸°í™”
        function init() {
            renderIndexedDB();

            // í…ŒìŠ¤íŠ¸ ì„¤ì • ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
            autoResponseCheckbox.addEventListener('change', (e) => {
                testConfig.autoResponseEnabled = e.target.checked;
                addLog('info', `ìë™ ì‘ë‹µ: ${e.target.checked ? 'í™œì„±í™”' : 'ë¹„í™œì„±í™”'}`);
            });

            responseDelayInput.addEventListener('change', (e) => {
                testConfig.responseDelay = parseInt(e.target.value) || 300;
                addLog('info', `ì‘ë‹µ ì§€ì—°: ${testConfig.responseDelay}ms`);
            });
        }

        function renderIndexedDB() {
            const list = document.getElementById('indexedDbList');
            list.innerHTML = Object.entries(mockIndexedDB).map(([key, value]) => `
                <div class="indexed-db-item ${value.enabled ? '' : 'disabled'}">
                    <label style="display: flex; align-items: center; flex: 1;">
                        <input type="checkbox" ${value.enabled ? 'checked' : ''} onchange="toggleDataItem('${key}', this.checked)">
                        <strong>${key}</strong>&nbsp;- ${value.description}
                    </label>
                    <span>${(value.size / 1024).toFixed(1)} KB</span>
                </div>
            `).join('');
        }

        function toggleDataItem(key, enabled) {
            mockIndexedDB[key].enabled = enabled;
            renderIndexedDB();
            addLog('info', `ë°ì´í„° '${key}': ${enabled ? 'í™œì„±í™”' : 'ë¹„í™œì„±í™”'}`);
        }

        function toggleAllData(enabled) {
            Object.keys(mockIndexedDB).forEach(key => {
                mockIndexedDB[key].enabled = enabled;
            });
            renderIndexedDB();
            addLog('info', `ëª¨ë“  ë°ì´í„°: ${enabled ? 'í™œì„±í™”' : 'ë¹„í™œì„±í™”'}`);
        }

        function updateStatus(state, message) {
            statusEl.className = `status ${state}`;
            statusEl.textContent = message;
            const isConnected = state === 'connected';
            disconnectBtn.disabled = !isConnected;
            scenario1Btn.disabled = !isConnected;
            scenario2Btn.disabled = !isConnected;
            scenario3Btn.disabled = !isConnected;
            scenario4aBtn.disabled = !isConnected;
            scenario4bBtn.disabled = !isConnected;
            tokenTestNormalBtn.disabled = !isConnected;
            tokenTestInvalidBtn.disabled = !isConnected;
            tokenTestDuplicateBtn.disabled = !isConnected;
        }

        // ========================================
        // One-Time Token í…ŒìŠ¤íŠ¸
        // ========================================

        function runTokenTest(mode) {
            tokenTestMode = mode;
            lastUsedRequestId = null;

            const modeNames = {
                'normal': 'ì •ìƒ ë§¤ì¹­',
                'invalid': 'ì˜ëª»ëœ í† í°',
                'duplicate': 'ì¤‘ë³µ ì‚¬ìš©'
            };

            addLog('info', `=== One-Time Token í…ŒìŠ¤íŠ¸: ${modeNames[mode]} ===`);
            addLog('info', `í…ŒìŠ¤íŠ¸ ëª¨ë“œ: ${mode}`);

            sendQuery(`í† í° í…ŒìŠ¤íŠ¸ (${mode})`);
        }

        // ========================================
        // í…ŒìŠ¤íŠ¸ ì‹œë‚˜ë¦¬ì˜¤ í•¨ìˆ˜
        // ========================================

        // ì‹œë‚˜ë¦¬ì˜¤ 1: ê¸°ë³¸ ì½œë°± íë¦„
        function runScenario1() {
            addLog('info', '=== ì‹œë‚˜ë¦¬ì˜¤ 1: ê¸°ë³¸ ì½œë°± íë¦„ ì‹œì‘ ===');

            // ì„¤ì • í™•ì¸
            testConfig.autoResponseEnabled = autoResponseCheckbox.checked;
            testConfig.responseDelay = parseInt(responseDelayInput.value) || 300;

            addLog('info', `ì„¤ì • - ìë™ì‘ë‹µ: ${testConfig.autoResponseEnabled}, ì§€ì—°: ${testConfig.responseDelay}ms`);

            // ëª¨ë“  ë°ì´í„° í™œì„±í™” í™•ì¸
            const enabledCount = Object.values(mockIndexedDB).filter(v => v.enabled).length;
            if (enabledCount === 0) {
                addLog('error', 'í™œì„±í™”ëœ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤. ë°ì´í„°ë¥¼ í™œì„±í™”í•´ì£¼ì„¸ìš”.');
                return;
            }

            sendQuery('ë¹„ìš© ë¶„ì„í•´ì¤˜');
        }

        // ì‹œë‚˜ë¦¬ì˜¤ 2: Clarification í…ŒìŠ¤íŠ¸
        function runScenario2() {
            addLog('info', '=== ì‹œë‚˜ë¦¬ì˜¤ 2: Clarification í…ŒìŠ¤íŠ¸ ì‹œì‘ ===');

            // ìë™ ì‘ë‹µ í™œì„±í™” í™•ì¸
            if (!testConfig.autoResponseEnabled) {
                testConfig.autoResponseEnabled = true;
                autoResponseCheckbox.checked = true;
                addLog('info', 'ìë™ ì‘ë‹µ í™œì„±í™”ë¨');
            }

            sendQuery('ì–´ë–¤ ë°ì´í„°ë¥¼ ì„ íƒí• ê¹Œìš”?');
        }

        // ì‹œë‚˜ë¦¬ì˜¤ 3: íƒ€ì„ì•„ì›ƒ í…ŒìŠ¤íŠ¸ (ì‘ë‹µ ì§€ì—°)
        function runScenario3() {
            addLog('info', '=== ì‹œë‚˜ë¦¬ì˜¤ 3: íƒ€ì„ì•„ì›ƒ í…ŒìŠ¤íŠ¸ ì‹œì‘ ===');

            // í˜„ì¬ ì„¤ì • ë°±ì—…
            testConfig.savedAutoResponse = testConfig.autoResponseEnabled;
            testConfig.savedResponseDelay = testConfig.responseDelay;

            // 15ì´ˆ ì§€ì—° ì„¤ì •
            testConfig.responseDelay = 15000;
            responseDelayInput.value = '15000';
            addLog('info', 'ì‘ë‹µ ì§€ì—°: 15ì´ˆ (ì„œë²„ íƒ€ì„ì•„ì›ƒ 10ì´ˆ ì´ˆê³¼)');
            addLog('info', '10ì´ˆ í›„ íƒ€ì„ì•„ì›ƒ ë°œìƒ ì˜ˆì •...');

            sendQuery('íƒ€ì„ì•„ì›ƒ í…ŒìŠ¤íŠ¸');

            // í…ŒìŠ¤íŠ¸ í›„ ì„¤ì • ë³µêµ¬ ì˜ˆì•½
            setTimeout(() => {
                restoreTestConfig();
            }, 16000);
        }

        // ì‹œë‚˜ë¦¬ì˜¤ 4-A: ì‘ë‹µ ì—†ìŒ (í´ë¼ì´ì–¸íŠ¸ ë©ˆì¶¤/ì˜¤ë¥˜)
        function runScenario4a() {
            addLog('info', '=== ì‹œë‚˜ë¦¬ì˜¤ 4-A: ì‘ë‹µ ì—†ìŒ í…ŒìŠ¤íŠ¸ ì‹œì‘ ===');

            // í˜„ì¬ ì„¤ì • ë°±ì—…
            testConfig.savedAutoResponse = testConfig.autoResponseEnabled;
            testConfig.savedResponseDelay = testConfig.responseDelay;

            // ìë™ ì‘ë‹µ ë¹„í™œì„±í™”
            testConfig.autoResponseEnabled = false;
            autoResponseCheckbox.checked = false;
            addLog('info', 'ìë™ ì‘ë‹µ ë¹„í™œì„±í™” (í´ë¼ì´ì–¸íŠ¸ê°€ ì‘ë‹µí•˜ì§€ ì•ŠìŒ)');
            addLog('info', '10ì´ˆ í›„ íƒ€ì„ì•„ì›ƒ ë°œìƒ ì˜ˆì •...');

            sendQuery('ì‘ë‹µ ì—†ìŒ í…ŒìŠ¤íŠ¸');

            // í…ŒìŠ¤íŠ¸ í›„ ì„¤ì • ë³µêµ¬ ì˜ˆì•½
            setTimeout(() => {
                restoreTestConfig();
            }, 12000);
        }

        // ì‹œë‚˜ë¦¬ì˜¤ 4-B: ë¹ˆ ë°ì´í„° (ìºì‹œ ì—†ìŒ)
        function runScenario4b() {
            addLog('info', '=== ì‹œë‚˜ë¦¬ì˜¤ 4-B: ë¹ˆ ë°ì´í„° í…ŒìŠ¤íŠ¸ ì‹œì‘ ===');

            // ëª¨ë“  ë°ì´í„° ë¹„í™œì„±í™”
            toggleAllData(false);
            addLog('info', 'ëª¨ë“  ë°ì´í„° ë¹„í™œì„±í™” (ìºì‹œ ì—†ìŒ ìƒí™© ì‹œë®¬ë ˆì´ì…˜)');

            sendQuery('ë¹ˆ ë°ì´í„° í…ŒìŠ¤íŠ¸');
        }

        function restoreTestConfig() {
            testConfig.autoResponseEnabled = testConfig.savedAutoResponse;
            testConfig.responseDelay = testConfig.savedResponseDelay;
            autoResponseCheckbox.checked = testConfig.savedAutoResponse;
            responseDelayInput.value = testConfig.savedResponseDelay.toString();
            addLog('info', 'í…ŒìŠ¤íŠ¸ ì„¤ì •ì´ ë³µêµ¬ë˜ì—ˆìŠµë‹ˆë‹¤.');
        }

        function restoreAndReset() {
            // ê¸°ë³¸ê°’ìœ¼ë¡œ ë³µêµ¬
            testConfig.autoResponseEnabled = true;
            testConfig.responseDelay = 300;
            testConfig.savedAutoResponse = true;
            testConfig.savedResponseDelay = 300;

            autoResponseCheckbox.checked = true;
            responseDelayInput.value = '300';

            // ëª¨ë“  ë°ì´í„° í™œì„±í™”
            toggleAllData(true);

            addLog('success', 'ëª¨ë“  ì„¤ì •ì´ ê¸°ë³¸ê°’ìœ¼ë¡œ ë³µêµ¬ë˜ì—ˆìŠµë‹ˆë‹¤.');
        }

        function addLog(type, message) {
            const time = new Date().toLocaleTimeString('ko-KR');
            const entry = document.createElement('div');
            entry.className = 'log-entry';
            let typeClass = 'log-info';
            let prefix = '';
            if (type === 'send') { typeClass = 'log-send'; prefix = '>>> '; }
            if (type === 'receive') { typeClass = 'log-receive'; prefix = '<<< '; }
            if (type === 'error') { typeClass = 'log-error'; prefix = '!!! '; }
            if (type === 'success') { typeClass = 'log-success'; prefix = 'OK '; }
            if (type === 'callback') { typeClass = 'log-callback'; prefix = '~~~ '; }
            entry.innerHTML = `<span class="log-time">[${time}]</span> <span class="${typeClass}">${prefix}${escapeHtml(message)}</span>`;
            logEl.appendChild(entry);
            logEl.scrollTop = logEl.scrollHeight;
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function clearLog() {
            logEl.innerHTML = '';
            callbackSteps = [];
            updateCallbackFlow();
        }

        function addCallbackStep(step) {
            callbackSteps.push(step);
            updateCallbackFlow();
        }

        function updateCallbackFlow() {
            if (callbackSteps.length === 0) {
                callbackFlowEl.textContent = 'ì½œë°± íë¦„ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤...';
                return;
            }
            callbackFlowEl.textContent = callbackSteps.join('\n');
        }

        // JWT ë°œê¸‰ & ì—°ê²°
        async function connectWithToken() {
            try {
                addLog('info', 'JWT ë°œê¸‰ ìš”ì²­...');
                const response = await fetch(`${SERVER_URL}/api/auth/token?username=test@example.com&name=í…ŒìŠ¤íŠ¸ì‚¬ìš©ì`, { method: 'POST' });
                const data = await response.json();
                currentToken = data.access_token;
                addLog('success', 'JWT ë°œê¸‰ ì„±ê³µ');
                connect();
            } catch (error) {
                addLog('error', `JWT ë°œê¸‰ ì‹¤íŒ¨: ${error.message}`);
            }
        }

        function connect() {
            updateStatus('connecting', 'ì—°ê²° ì¤‘...');
            const url = `${WS_URL}?token=${currentToken}`;
            ws = new WebSocket(url);

            ws.onopen = () => addLog('success', 'WebSocket ì—°ê²° ì„±ê³µ');
            ws.onmessage = (event) => handleMessage(JSON.parse(event.data));
            ws.onerror = () => addLog('error', 'WebSocket ì—ëŸ¬');
            ws.onclose = (event) => {
                updateStatus('disconnected', 'ì—°ê²° ì•ˆë¨');
                addLog('info', `ì—°ê²° ì¢…ë£Œ (code: ${event.code})`);
                ws = null;
            };
        }

        function disconnect() {
            if (ws) ws.close();
        }

        // ë©”ì‹œì§€ ì²˜ë¦¬
        function handleMessage(data) {
            const type = data.type;
            addLog('receive', `${type}: ${JSON.stringify(data).substring(0, 80)}...`);

            switch (type) {
                case 'connected':
                    updateStatus('connected', 'ì—°ê²°ë¨');
                    addLog('success', `ì¸ì¦ ì™„ë£Œ: ${data.user?.name}`);
                    break;

                case 'request_available_data':
                    handleRequestAvailableData(data);
                    break;

                case 'request_api':
                    handleRequestApi(data);
                    break;

                case 'clarification_request':
                    handleClarificationRequest(data);
                    break;

                case 'response':
                    addCallbackStep(`6. Server â†’ Client: response`);
                    const answer = data.answer || '';
                    if (answer.includes('íƒ€ì„ì•„ì›ƒ')) {
                        addLog('error', 'ìµœì¢… ì‘ë‹µ: íƒ€ì„ì•„ì›ƒ ë°œìƒ!');
                    } else if (answer.includes('ì˜¤ë¥˜')) {
                        addLog('error', 'ìµœì¢… ì‘ë‹µ: ì˜¤ë¥˜ ë°œìƒ');
                    } else {
                        addLog('success', 'ìµœì¢… ì‘ë‹µ ìˆ˜ì‹  (ì„±ê³µ)');
                    }
                    break;

                case 'ping':
                    sendMessage({ type: 'pong' });
                    break;

                case 'error':
                    addLog('error', `ì—ëŸ¬ [${data.code}]: ${data.message}`);
                    break;
            }
        }

        // ì½œë°± ì‘ë‹µ ì²˜ë¦¬
        function handleRequestAvailableData(data) {
            const requestId = data.requestId;
            const timeout = data.timeout || 10000;

            // í† í° ë°œê¸‰ ë¡œê·¸ (ëª…í™•íˆ í‘œì‹œ)
            addLog('callback', `â”â”â” One-Time Token ë°œê¸‰ â”â”â”`);
            addLog('callback', `Token: ${requestId}`);
            addLog('callback', `â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”`);

            addCallbackStep(`2. Server â†’ Client: request_available_data`);
            addCallbackStep(`   Token ë°œê¸‰: ${requestId}`);

            // ìë™ ì‘ë‹µì´ ë¹„í™œì„±í™”ëœ ê²½ìš°
            if (!testConfig.autoResponseEnabled) {
                addLog('info', `âš ï¸ ìë™ ì‘ë‹µ ë¹„í™œì„±í™” - ì‘ë‹µì„ ë³´ë‚´ì§€ ì•ŠìŠµë‹ˆë‹¤ (${timeout}ms í›„ íƒ€ì„ì•„ì›ƒ ì˜ˆìƒ)`);
                return;
            }

            // Mock IndexedDB ëª©ë¡ ì‘ë‹µ (í™œì„±í™”ëœ ë°ì´í„°ë§Œ)
            const availableData = Object.entries(mockIndexedDB)
                .filter(([key, value]) => value.enabled)
                .map(([key, value]) => ({
                    key,
                    description: value.description,
                    size: value.size
                }));

            const delay = testConfig.responseDelay;

            setTimeout(() => {
                // í† í° í…ŒìŠ¤íŠ¸ ëª¨ë“œì— ë”°ë¼ ì‘ë‹µ requestId ê²°ì •
                let responseRequestId = requestId;

                if (tokenTestMode === 'invalid') {
                    responseRequestId = 'invalid-token-12345-xyz';
                    addLog('info', `ğŸ”‘ ì˜ëª»ëœ í† í° í…ŒìŠ¤íŠ¸: ${responseRequestId}`);
                } else if (tokenTestMode === 'duplicate') {
                    if (lastUsedRequestId === requestId) {
                        addLog('info', `ğŸ”‘ ì¤‘ë³µ ì‚¬ìš© í…ŒìŠ¤íŠ¸: ê°™ì€ í† í°ìœ¼ë¡œ ì¬ì „ì†¡`);
                    } else {
                        lastUsedRequestId = requestId;
                        // ì²« ë²ˆì§¸ëŠ” ì •ìƒ ì „ì†¡, ë°”ë¡œ ë‹¤ìŒì— ì¤‘ë³µ ì „ì†¡
                        setTimeout(() => {
                            addLog('info', `ğŸ”‘ ì¤‘ë³µ ì‚¬ìš© í…ŒìŠ¤íŠ¸: ê°™ì€ í† í°ìœ¼ë¡œ ë‘ ë²ˆì§¸ ì „ì†¡`);
                            sendMessage({
                                type: 'available_data',
                                requestId: requestId,
                                data: availableData
                            });
                            addLog('callback', `available_data ì¤‘ë³µ ì „ì†¡ (Token: ${requestId.substring(0, 20)}...)`);
                        }, 100);
                    }
                }

                addCallbackStep(`3. Client â†’ Server: available_data`);
                addCallbackStep(`   Token ì‚¬ìš©: ${responseRequestId.substring(0, 25)}...`);

                sendMessage({
                    type: 'available_data',
                    requestId: responseRequestId,
                    data: availableData
                });
                addLog('callback', `available_data ì‘ë‹µ (Token: ${responseRequestId.substring(0, 20)}...)`);

                // í…ŒìŠ¤íŠ¸ ëª¨ë“œ ì´ˆê¸°í™”
                if (tokenTestMode !== 'normal') {
                    tokenTestMode = 'normal';
                }
            }, delay);
        }

        function handleRequestApi(data) {
            const requestId = data.requestId;
            const dataKey = data.dataKey;
            const timeout = data.timeout || 60000;

            // í† í° ë°œê¸‰ ë¡œê·¸
            addLog('callback', `â”â”â” One-Time Token ë°œê¸‰ â”â”â”`);
            addLog('callback', `Token: ${requestId}`);
            addLog('callback', `â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”`);

            addCallbackStep(`4. Server â†’ Client: request_api (dataKey: ${dataKey})`);
            addCallbackStep(`   Token ë°œê¸‰: ${requestId}`);

            // ìë™ ì‘ë‹µì´ ë¹„í™œì„±í™”ëœ ê²½ìš°
            if (!testConfig.autoResponseEnabled) {
                addLog('info', `âš ï¸ ìë™ ì‘ë‹µ ë¹„í™œì„±í™” - ì‘ë‹µì„ ë³´ë‚´ì§€ ì•ŠìŠµë‹ˆë‹¤ (${timeout}ms í›„ íƒ€ì„ì•„ì›ƒ ì˜ˆìƒ)`);
                return;
            }

            // Mock IndexedDBì—ì„œ ë°ì´í„° ì¡°íšŒ (í™œì„±í™”ëœ ë°ì´í„°ë§Œ)
            const storedData = mockIndexedDB[dataKey];
            const isEnabled = storedData && storedData.enabled;

            const delay = testConfig.responseDelay;

            setTimeout(() => {
                addCallbackStep(`5. Client â†’ Server: api_result`);
                addCallbackStep(`   Token ì‚¬ìš©: ${requestId.substring(0, 25)}...`);

                if (isEnabled) {
                    sendMessage({
                        type: 'api_result',
                        requestId: requestId,
                        success: true,
                        data: storedData.data
                    });
                    addLog('callback', `api_result ì‘ë‹µ (Token: ${requestId.substring(0, 20)}..., success)`);
                } else {
                    sendMessage({
                        type: 'api_result',
                        requestId: requestId,
                        success: false,
                        error: { code: 'NOT_FOUND', message: `ë°ì´í„° ì—†ìŒ ë˜ëŠ” ë¹„í™œì„±í™”: ${dataKey}` }
                    });
                    addLog('callback', `api_result ì‘ë‹µ (Token: ${requestId.substring(0, 20)}..., error)`);
                }
            }, delay);
        }

        function handleClarificationRequest(data) {
            const requestId = data.requestId;

            // í† í° ë°œê¸‰ ë¡œê·¸
            addLog('callback', `â”â”â” One-Time Token ë°œê¸‰ â”â”â”`);
            addLog('callback', `Token: ${requestId}`);
            addLog('callback', `â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”`);

            addCallbackStep(`*. Server â†’ Client: clarification_request`);
            addCallbackStep(`   Token ë°œê¸‰: ${requestId}`);
            addLog('callback', `ì‚¬ìš©ì ì…ë ¥ ìš”ì²­: ${data.question}`);

            // ëª¨ë‹¬ í‘œì‹œ
            pendingClarification = { requestId };
            showClarificationModal(data);
        }

        function showClarificationModal(data) {
            const modal = document.getElementById('clarificationModal');
            const questionEl = document.getElementById('modalQuestion');
            const optionsEl = document.getElementById('modalOptions');
            const textInputEl = document.getElementById('modalTextInput');

            questionEl.textContent = data.question;

            if (data.options && data.options.length > 0) {
                optionsEl.innerHTML = data.options.map(opt => `
                    <div class="modal-option" onclick="selectOption(this, '${opt}')">${opt}</div>
                `).join('');
                optionsEl.style.display = 'flex';
                textInputEl.style.display = 'none';
            } else {
                optionsEl.style.display = 'none';
                textInputEl.style.display = 'flex';
            }

            modal.classList.add('show');
        }

        function selectOption(el, value) {
            document.querySelectorAll('.modal-option').forEach(opt => opt.classList.remove('selected'));
            el.classList.add('selected');
            pendingClarification.selectedOption = value;
        }

        function submitClarification() {
            if (!pendingClarification) return;

            const textValue = document.getElementById('modalTextValue').value;
            const response = pendingClarification.selectedOption || textValue;
            const requestId = pendingClarification.requestId;

            addCallbackStep(`*. Client â†’ Server: human_response (${response})`);
            addCallbackStep(`   Token ì‚¬ìš©: ${requestId.substring(0, 25)}...`);

            sendMessage({
                type: 'human_response',
                requestId: requestId,
                response: response,
                selectedOption: pendingClarification.selectedOption
            });
            addLog('callback', `human_response ì‘ë‹µ (Token: ${requestId.substring(0, 20)}..., ì‘ë‹µ: ${response})`);

            closeClarificationModal();
        }

        function cancelClarification() {
            closeClarificationModal();
        }

        function closeClarificationModal() {
            document.getElementById('clarificationModal').classList.remove('show');
            pendingClarification = null;
        }

        // ë©”ì‹œì§€ ì „ì†¡
        function sendMessage(data) {
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify(data));
                if (!['pong', 'available_data', 'api_result', 'human_response'].includes(data.type)) {
                    addLog('send', `${data.type}`);
                }
            }
        }

        function sendQuery(query) {
            if (!query) return;

            callbackSteps = [];
            addCallbackStep(`1. Client â†’ Server: query ("${query.substring(0, 30)}...")`);

            sendMessage({
                type: 'query',
                query: query,
                domContext: '{}',
                page: { url: window.location.href, title: document.title }
            });
        }

        init();
    </script>
</body>
</html>